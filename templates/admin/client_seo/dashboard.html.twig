{% extends '@EasyAdmin/page/content.html.twig' %}

{% block content_title %}
    <i class="fa fa-chart-line"></i> SEO - {{ site.name }}
{% endblock %}

{% block page_content %}
{% include 'admin/dashboard/_partials/_styles.html.twig' %}

<!-- Navigation -->
<div style="margin-bottom: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: space-between; align-items: center;">
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <a href="{{ path('admin_client_seo_list') }}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Retour a la liste
        </a>
        <a href="{{ path('admin_client_seo_import', {id: site.id}) }}" class="btn btn-sm btn-primary">
            <i class="fas fa-file-upload"></i> Importer CSV
        </a>
        <a href="{{ path('admin_client_seo_import_history', {id: site.id}) }}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-history"></i> Historique
        </a>
        <a href="{{ path('admin_client_seo_keywords', {id: site.id}) }}" class="btn btn-sm btn-outline-primary">
            <i class="fas fa-key"></i> Mots-cles
        </a>
        <a href="{{ path('admin_client_seo_export_csv', {id: site.id}) }}" class="btn btn-sm btn-success">
            <i class="fas fa-file-csv"></i> Exporter
        </a>
        <form action="{{ path('admin_client_seo_report_generate', {id: site.id}) }}" method="POST" style="display: inline;">
            <input type="hidden" name="_token" value="{{ csrf_token('generate-report-' ~ site.id) }}">
            <button type="submit" class="btn btn-sm btn-warning">
                <i class="fas fa-file-alt"></i> Generer compte rendu
            </button>
        </form>
        <a href="{{ path('admin_client_seo_report_list', {id: site.id}) }}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-list-alt"></i> Historique CR
        </a>
    </div>
    <a href="{{ path('admin_client_seo_edit_site', {id: site.id}) }}" class="btn btn-sm btn-outline-secondary">
        <i class="fas fa-cog"></i> Parametres
    </a>
</div>

<!-- Site Info Card -->
<div class="stat-card info" style="margin-bottom: 1.5rem;">
    <div class="stat-header">
        <span class="stat-label">{{ site.client.displayName }}</span>
        <div class="stat-icon info">
            <i class="fas fa-globe"></i>
        </div>
    </div>
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div>
            <div style="font-weight: 600; color: #111827;">{{ site.url }}</div>
            {% if lastImportDate %}
                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                    <i class="fas fa-sync-alt"></i> Dernier import : {{ lastImportDate|date('d/m/Y a H:i') }}
                </div>
            {% else %}
                <div style="font-size: 0.75rem; color: #f59e0b; margin-top: 0.25rem;">
                    <i class="fas fa-exclamation-triangle"></i> Aucun import effectue -
                    <a href="{{ path('admin_client_seo_import', {id: site.id}) }}" style="color: var(--primary); text-decoration: underline;">Importer des donnees</a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% if keywordsRanked.top10|length > 0 or keywordsRanked.toImprove|length > 0 %}

<!-- Top 10 Keywords -->
<div class="chart-container" style="padding: 1rem 1.5rem; margin-bottom: 1.5rem;">
    <div class="chart-title" style="margin-bottom: 1rem;">
        <i class="fas fa-trophy" style="color: #10b981;"></i>
        Top 10 - Meilleures performances
        <span style="font-size: 0.75rem; font-weight: 400; color: #6b7280; margin-left: 0.5rem;">
            (par score de visibilite)
        </span>
    </div>
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
            <thead>
                <tr style="border-bottom: 2px solid #10b981;">
                    <th style="text-align: left; padding: 0.75rem 0.5rem; color: #065f46; font-weight: 600;">Mot-cle</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #065f46; font-weight: 600;">Score</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #065f46; font-weight: 600;">Position</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #065f46; font-weight: 600;">vs M-1</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #065f46; font-weight: 600;">Tendance 4S</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #065f46; font-weight: 600;">Stabilite</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #065f46; font-weight: 600;">Clics</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #065f46; font-weight: 600;">Impressions</th>
                </tr>
            </thead>
            <tbody>
                {% for keyword in keywordsRanked.top10 %}
                    {% set latestPosition = keyword.latestPosition %}
                    {% set comparison = positionComparisons[keyword.id] ?? null %}
                    <tr style="border-bottom: 1px solid #d1fae5;">
                        <td style="padding: 0.75rem 0.5rem; font-weight: 500;">{{ keyword.keyword }}</td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            <span class="seo-star-group" data-score="{{ keyword.relevanceScore }}" data-url="{{ path('admin_client_seo_keyword_set_score', {id: keyword.id}) }}" data-token="{{ csrf_token('client-seo-score-' ~ keyword.id) }}" style="cursor: pointer; white-space: nowrap;">
                                {% for i in 1..5 %}
                                    <i class="{{ keyword.relevanceScore >= i ? 'fas' : 'far' }} fa-star seo-star" data-value="{{ i }}" style="color: {{ keyword.relevanceScore >= i ? '#f59e0b' : '#d1d5db' }}; font-size: 0.75rem;"></i>
                                {% endfor %}
                                {% if keyword.relevanceScore == 0 %}<span style="color: #d1d5db; font-size: 0.7rem; margin-left: 2px;">?</span>{% endif %}
                            </span>
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% if latestPosition %}
                                {% set pos = latestPosition.position %}
                                {% if pos <= 10 %}
                                    <span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">{{ pos|number_format(1) }}</span>
                                {% elseif pos <= 20 %}
                                    <span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">{{ pos|number_format(1) }}</span>
                                {% else %}
                                    <span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">{{ pos|number_format(1) }}</span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% if comparison %}
                                {% if comparison.status == 'improved' %}
                                    <span style="color: #10b981; font-weight: 600;"><i class="fas fa-arrow-up"></i> +{{ comparison.variation|abs|number_format(1) }}</span>
                                {% elseif comparison.status == 'degraded' %}
                                    <span style="color: #ef4444; font-weight: 600;"><i class="fas fa-arrow-down"></i> {{ comparison.variation|number_format(1) }}</span>
                                {% elseif comparison.status == 'stable' %}
                                    <span style="color: #6b7280;">=</span>
                                {% elseif comparison.status == 'new' %}
                                    <span style="background: #dbeafe; color: #1d4ed8; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Nouveau</span>
                                {% else %}
                                    <span style="color: #9ca3af;">-</span>
                                {% endif %}
                            {% else %}
                                <span style="color: #9ca3af;">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% set momentumData = seoMomentum[keyword.id] ?? null %}
                            {% if momentumData %}
                                {% if momentumData.status == 'improved' %}
                                    <span style="color: #10b981; font-weight: 600; font-size: 0.8rem;"><i class="fas fa-arrow-up"></i> +{{ momentumData.trend|abs|number_format(1) }}</span>
                                {% elseif momentumData.status == 'degraded' %}
                                    <span style="color: #ef4444; font-weight: 600; font-size: 0.8rem;"><i class="fas fa-arrow-down"></i> {{ momentumData.trend|number_format(1) }}</span>
                                {% else %}
                                    <span style="color: #6b7280; font-size: 0.8rem;">=</span>
                                {% endif %}
                            {% else %}
                                <span style="color: #9ca3af;">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% set stabilityVal = seoStability[keyword.id] ?? null %}
                            {% if stabilityVal is not null and stabilityVal < 99 %}
                                {% if stabilityVal < 2 %}
                                    <span style="background: #d1fae5; color: #065f46; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">Stable</span>
                                {% elseif stabilityVal < 5 %}
                                    <span style="background: #fef3c7; color: #92400e; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">Variable</span>
                                {% else %}
                                    <span style="background: #fee2e2; color: #991b1b; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">Instable</span>
                                {% endif %}
                            {% else %}
                                <span style="color: #9ca3af; font-size: 0.75rem;">Insuff.</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            <span style="font-weight: 700; color: #065f46;">{{ latestPosition.clicks }}</span>
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {{ latestPosition.impressions|number_format(0, '', ' ') }}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Keywords to Improve -->
{% if keywordsRanked.toImprove|length > 0 %}
<div class="chart-container" style="padding: 1rem 1.5rem; margin-bottom: 1.5rem;">
    <div class="chart-title" style="margin-bottom: 1rem;">
        <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
        A travailler
        <span style="font-size: 0.75rem; font-weight: 400; color: #6b7280; margin-left: 0.5rem;">(criteres avances : CTR, proximite top 10, declin, volume)</span>
    </div>
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
            <thead>
                <tr style="border-bottom: 2px solid #f59e0b;">
                    <th style="text-align: left; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">Mot-cle</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">Score</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">Position</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">vs M-1</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">Tendance 4S</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">Stabilite</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">Clics</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">Impr.</th>
                    <th style="text-align: left; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">Raison</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">Fait</th>
                </tr>
            </thead>
            <tbody>
                {% for item in keywordsRanked.toImprove %}
                    {% set keyword = item.keyword %}
                    {% set latestPosition = keyword.latestPosition %}
                    {% set comparison = positionComparisons[keyword.id] ?? null %}
                    {% set momentumData = seoMomentum[keyword.id] ?? null %}
                    <tr id="client-seo-improve-row-{{ keyword.id }}" style="border-bottom: 1px solid #fef3c7;">
                        <td style="padding: 0.75rem 0.5rem; font-weight: 500;">{{ keyword.keyword }}</td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            <span class="seo-star-group" data-score="{{ keyword.relevanceScore }}" data-url="{{ path('admin_client_seo_keyword_set_score', {id: keyword.id}) }}" data-token="{{ csrf_token('client-seo-score-' ~ keyword.id) }}" style="cursor: pointer; white-space: nowrap;">
                                {% for i in 1..5 %}
                                    <i class="{{ keyword.relevanceScore >= i ? 'fas' : 'far' }} fa-star seo-star" data-value="{{ i }}" style="color: {{ keyword.relevanceScore >= i ? '#f59e0b' : '#d1d5db' }}; font-size: 0.75rem;"></i>
                                {% endfor %}
                                {% if keyword.relevanceScore == 0 %}<span style="color: #d1d5db; font-size: 0.7rem; margin-left: 2px;">?</span>{% endif %}
                            </span>
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% if latestPosition %}
                                {% set pos = latestPosition.position %}
                                {% if pos <= 10 %}
                                    <span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">{{ pos|number_format(1) }}</span>
                                {% elseif pos <= 20 %}
                                    <span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">{{ pos|number_format(1) }}</span>
                                {% else %}
                                    <span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">{{ pos|number_format(1) }}</span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% if comparison %}
                                {% if comparison.status == 'improved' %}
                                    <span style="color: #10b981; font-weight: 600;"><i class="fas fa-arrow-up"></i> +{{ comparison.variation|abs|number_format(1) }}</span>
                                {% elseif comparison.status == 'degraded' %}
                                    <span style="color: #ef4444; font-weight: 600;"><i class="fas fa-arrow-down"></i> {{ comparison.variation|number_format(1) }}</span>
                                {% elseif comparison.status == 'stable' %}
                                    <span style="color: #6b7280;">=</span>
                                {% elseif comparison.status == 'new' %}
                                    <span style="background: #dbeafe; color: #1d4ed8; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Nouveau</span>
                                {% else %}
                                    <span style="color: #9ca3af;">-</span>
                                {% endif %}
                            {% else %}
                                <span style="color: #9ca3af;">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% if momentumData %}
                                {% if momentumData.status == 'improved' %}
                                    <span style="color: #10b981; font-weight: 600; font-size: 0.8rem;"><i class="fas fa-arrow-up"></i> +{{ momentumData.trend|abs|number_format(1) }}</span>
                                {% elseif momentumData.status == 'degraded' %}
                                    <span style="color: #ef4444; font-weight: 600; font-size: 0.8rem;"><i class="fas fa-arrow-down"></i> {{ momentumData.trend|number_format(1) }}</span>
                                {% else %}
                                    <span style="color: #6b7280; font-size: 0.8rem;">=</span>
                                {% endif %}
                            {% else %}
                                <span style="color: #9ca3af;">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% set stabilityVal = seoStability[keyword.id] ?? null %}
                            {% if stabilityVal is not null and stabilityVal < 99 %}
                                {% if stabilityVal < 2 %}
                                    <span style="background: #d1fae5; color: #065f46; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">Stable</span>
                                {% elseif stabilityVal < 5 %}
                                    <span style="background: #fef3c7; color: #92400e; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">Variable</span>
                                {% else %}
                                    <span style="background: #fee2e2; color: #991b1b; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">Instable</span>
                                {% endif %}
                            {% else %}
                                <span style="color: #9ca3af; font-size: 0.75rem;">Insuff.</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            <span style="font-weight: 600; color: #92400e;">{{ latestPosition.clicks }}</span>
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {{ latestPosition.impressions|number_format(0, '', ' ') }}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            <span title="{{ item.action }}" style="cursor: help; color: #92400e; font-size: 0.8rem; white-space: nowrap;">
                                {{ item.reason }} <i class="fas fa-info-circle" style="color: #d97706; font-size: 0.7rem;"></i>
                            </span>
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            <button type="button"
                                class="btn btn-sm btn-outline-success client-seo-mark-done"
                                data-keyword-id="{{ keyword.id }}"
                                data-url="{{ path('admin_client_seo_keyword_mark_optimized', {id: keyword.id}) }}"
                                data-token="{{ csrf_token('client-seo-optimize-' ~ keyword.id) }}"
                                title="Marquer comme optimise aujourd'hui"
                                style="font-size: 0.75rem; padding: 0.15rem 0.5rem;">
                                <i class="fas fa-check"></i> Fait
                            </button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- SEO Evolution Chart -->
<div class="chart-container" style="margin-bottom: 1.5rem;">
    <div class="chart-title">
        <i class="fas fa-chart-line" style="color: var(--info);"></i>
        Evolution SEO - 30 derniers jours
    </div>
    {% if chartData.hasEnoughData %}
        <canvas id="chartSeoEvolution" class="chart-canvas"></canvas>
    {% else %}
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; color: #6b7280;">
            <i class="fas fa-chart-line" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
            <div style="font-size: 0.875rem; text-align: center;">
                Donnees insuffisantes pour afficher les tendances<br>
                <span style="font-size: 0.75rem; opacity: 0.7;">({{ chartData.daysWithData }} jour{{ chartData.daysWithData > 1 ? 's' : '' }} de donnees, minimum 7 requis)</span>
            </div>
        </div>
    {% endif %}
</div>

<!-- 7-Day Rolling Chart -->
<div class="chart-container" style="margin-bottom: 1.5rem;">
    <div class="chart-title">
        <i class="fas fa-chart-area" style="color: var(--primary);"></i>
        Tendances SEO - Moyenne glissante 7 jours
    </div>
    {% if chartData.hasEnoughData %}
        <canvas id="chartSeo7d" class="chart-canvas"></canvas>
    {% else %}
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; color: #6b7280;">
            <i class="fas fa-chart-area" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
            <div style="font-size: 0.875rem;">Donnees insuffisantes</div>
        </div>
    {% endif %}
</div>

<!-- Performance Categories -->
<div class="grid-2" style="margin-bottom: 1.5rem;">
    <div class="chart-container" style="height: auto; padding: 1.25rem;">
        <div class="chart-title" style="margin-bottom: 1rem;">
            <i class="fas fa-trophy" style="color: var(--success);"></i>
            Top Performers
        </div>
        {% if performanceData.topPerformers|length > 0 %}
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                {% for item in performanceData.topPerformers %}
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f0fdf4; border-radius: 8px;">
                        <div style="font-weight: 500; font-size: 0.875rem;">{{ item.keyword }}</div>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="background: #d1fae5; color: #065f46; padding: 0.125rem 0.5rem; border-radius: 9999px; font-weight: 700; font-size: 0.75rem;">
                                #{{ item.position|number_format(0) }}
                            </span>
                            {% if item.clicks > 0 %}
                                <span style="color: #065f46; font-size: 0.75rem; font-weight: 600;">{{ item.clicks }} clic{{ item.clicks > 1 ? 's' : '' }}</span>
                            {% else %}
                                <span style="color: #6b7280; font-size: 0.75rem;">{{ item.impressions }} imp.</span>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; color: #6b7280;">
                <i class="fas fa-trophy" style="font-size: 2rem; opacity: 0.3; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 0.875rem;">Pas assez de donnees</div>
            </div>
        {% endif %}
    </div>

    <div class="chart-container" style="height: auto; padding: 1.25rem;">
        <div class="chart-title" style="margin-bottom: 1rem;">
            <i class="fas fa-wrench" style="color: #f59e0b;"></i>
            A travailler
        </div>
        {% if performanceData.toImprove|length > 0 %}
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                {% for item in performanceData.toImprove %}
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #fffbeb; border-radius: 8px;">
                        <div style="font-weight: 500; font-size: 0.875rem;">{{ item.keyword }}</div>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="background: #fef3c7; color: #92400e; padding: 0.125rem 0.5rem; border-radius: 9999px; font-weight: 700; font-size: 0.75rem;">
                                #{{ item.position|number_format(0) }}
                            </span>
                            {% if item.clicks > 0 %}
                                <span style="color: #92400e; font-size: 0.75rem; font-weight: 600;">{{ item.clicks }} clic{{ item.clicks > 1 ? 's' : '' }}</span>
                            {% else %}
                                <span style="color: #6b7280; font-size: 0.75rem;">{{ item.impressions }} imp.</span>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; color: #6b7280;">
                <i class="fas fa-check-circle" style="font-size: 2rem; opacity: 0.3; color: #10b981; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 0.875rem;">Pas assez de donnees</div>
            </div>
        {% endif %}
    </div>
</div>

<!-- CTR Opportunities -->
{% if performanceData.ctrOpportunities|length > 0 %}
<div class="chart-container" style="height: auto; padding: 1.25rem; margin-bottom: 1.5rem;">
    <div class="chart-title" style="margin-bottom: 1rem;">
        <i class="fas fa-lightbulb" style="color: var(--warning);"></i>
        Opportunites CTR
        <span style="font-size: 0.75rem; font-weight: 400; color: #6b7280; margin-left: 0.5rem;">(Beaucoup d'impressions, peu de clics)</span>
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 0.75rem;">
        {% for item in performanceData.ctrOpportunities %}
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #fffbeb; border-radius: 8px; border-left: 3px solid #f59e0b;">
                <div>
                    <div style="font-weight: 500; font-size: 0.875rem;">{{ item.keyword }}</div>
                    <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                        {{ item.impressions|number_format(0, '', ' ') }} impressions
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 700; font-size: 0.875rem;">
                        CTR {{ item.ctr }}%
                    </div>
                    <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                        {{ item.clicks }} clics
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Top Pages -->
{% if topPages|length > 0 %}
<div class="chart-container" style="padding: 1rem 1.5rem; margin-bottom: 1.5rem;">
    <div class="chart-title" style="margin-bottom: 1rem;">
        <i class="fas fa-file-alt" style="color: var(--info);"></i>
        Top Pages
    </div>
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
            <thead>
                <tr style="border-bottom: 2px solid var(--info);">
                    <th style="text-align: left; padding: 0.75rem 0.5rem; color: #0e7490; font-weight: 600;">Page</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #0e7490; font-weight: 600;">Clics</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #0e7490; font-weight: 600;">Impressions</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #0e7490; font-weight: 600;">Position</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #0e7490; font-weight: 600;">CTR</th>
                </tr>
            </thead>
            <tbody>
                {% for page in topPages %}
                    <tr style="border-bottom: 1px solid #e0f2fe;">
                        <td style="padding: 0.75rem 0.5rem; max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            <a href="{{ page.url }}" target="_blank" style="color: #0369a1; text-decoration: none;" title="{{ page.url }}">
                                {{ page.url|slice(-60) }}
                            </a>
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem; font-weight: 700; color: #0e7490;">
                            {{ page.totalClicks }}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {{ page.totalImpressions|number_format(0, '', ' ') }}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% set pos = page.avgPosition %}
                            {% if pos <= 10 %}
                                <span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">{{ pos|number_format(1) }}</span>
                            {% elseif pos <= 20 %}
                                <span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">{{ pos|number_format(1) }}</span>
                            {% else %}
                                <span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">{{ pos|number_format(1) }}</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {{ page.avgCtr|number_format(2) }}%
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% else %}
<!-- No data state -->
<div class="stat-card info" style="text-align: center; padding: 3rem; margin-bottom: 1.5rem;">
    <i class="fas fa-file-upload" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem; display: block;"></i>
    <div style="font-size: 1.125rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Aucune donnee SEO</div>
    <div style="color: #6b7280; margin-bottom: 1.5rem;">
        Importez un export CSV de Google Search Console pour commencer l'analyse SEO de ce site.
    </div>
    <a href="{{ path('admin_client_seo_import', {id: site.id}) }}" class="btn btn-primary">
        <i class="fas fa-file-upload"></i> Importer un fichier CSV
    </a>
    <div style="margin-top: 1.5rem; padding: 1rem; background: #f0f9ff; border-radius: 8px; text-align: left; font-size: 0.875rem; color: #0369a1;">
        <div style="font-weight: 600; margin-bottom: 0.5rem;"><i class="fas fa-info-circle"></i> Comment exporter depuis Google Search Console :</div>
        <ol style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
            <li>Allez sur <strong>Google Search Console</strong> > Performance</li>
            <li>Selectionnez la periode souhaitee (3 derniers mois recommandes)</li>
            <li>Ajoutez la dimension <strong>Date</strong> (important !)</li>
            <li>Cliquez sur <strong>Exporter</strong> > Telecharger le fichier CSV</li>
            <li>Repetez pour l'onglet <strong>Pages</strong></li>
        </ol>
    </div>
</div>
{% endif %}

<!-- Chart.js Scripts -->
{% if keywordsRanked.top10|length > 0 or keywordsRanked.toImprove|length > 0 %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
Chart.defaults.plugins.legend.display = true;
Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(17, 24, 39, 0.95)';
Chart.defaults.plugins.tooltip.padding = 12;
Chart.defaults.plugins.tooltip.cornerRadius = 8;

const seoChartLabels = {{ chartData.labels|json_encode|raw }};
const seoChartClicks = {{ chartData.clicks|json_encode|raw }};
const seoChartImpressions = {{ chartData.impressions|json_encode|raw }};
const seoChartCtr = {{ chartData.ctr|json_encode|raw }};
const seoChartPosition = {{ chartData.position|json_encode|raw }};
const seoChartClicks7d = {{ chartData.clicks7d|json_encode|raw }};
const seoChartImpressions7d = {{ chartData.impressions7d|json_encode|raw }};
const seoChartCtr7d = {{ chartData.ctr7d|json_encode|raw }};
const seoChartPosition7d = {{ chartData.position7d|json_encode|raw }};
const seoHasEnoughData = {{ chartData.hasEnoughData ? 'true' : 'false' }};

// Daily chart
if (seoHasEnoughData && document.getElementById('chartSeoEvolution')) {
    new Chart(document.getElementById('chartSeoEvolution'), {
        type: 'line',
        data: {
            labels: seoChartLabels,
            datasets: [
                { label: 'Clics', data: seoChartClicks, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4, borderWidth: 2, pointRadius: 2, pointHoverRadius: 5, yAxisID: 'yClicks' },
                { label: 'Impressions', data: seoChartImpressions, borderColor: '#06b6d4', backgroundColor: 'rgba(6, 182, 212, 0.05)', fill: true, tension: 0.4, borderWidth: 2, pointRadius: 2, pointHoverRadius: 5, yAxisID: 'yImpressions' },
                { label: 'CTR (%)', data: seoChartCtr, borderColor: '#8b5cf6', backgroundColor: 'transparent', fill: false, tension: 0.4, borderWidth: 2, borderDash: [4, 4], pointRadius: 0, pointHoverRadius: 4, yAxisID: 'yCtr' },
                { label: 'Position', data: seoChartPosition, borderColor: '#f59e0b', backgroundColor: 'transparent', fill: false, tension: 0.4, borderWidth: 2, borderDash: [2, 2], pointRadius: 0, pointHoverRadius: 4, yAxisID: 'yPosition' }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 12, font: { size: 11 } } },
                tooltip: { callbacks: {
                    title: (items) => items.length > 0 ? 'Date: ' + items[0].label : '',
                    label: (ctx) => { let v = ctx.parsed.y; if (ctx.dataset.label === 'CTR (%)') return ctx.dataset.label + ': ' + v.toFixed(2) + '%'; if (ctx.dataset.label === 'Position') return ctx.dataset.label + ': ' + v.toFixed(1); return ctx.dataset.label + ': ' + v.toLocaleString('fr-FR'); }
                }}
            },
            scales: {
                yClicks: { type: 'linear', display: true, position: 'left', beginAtZero: true, title: { display: true, text: 'Clics', color: '#3b82f6', font: { size: 10 } }, ticks: { color: '#3b82f6', font: { size: 9 } }, grid: { color: 'rgba(0,0,0,0.05)' } },
                yImpressions: { type: 'linear', display: true, position: 'right', beginAtZero: true, title: { display: true, text: 'Impressions', color: '#06b6d4', font: { size: 10 } }, ticks: { color: '#06b6d4', font: { size: 9 } }, grid: { drawOnChartArea: false } },
                yCtr: { type: 'linear', display: false, beginAtZero: true, max: 10, grid: { drawOnChartArea: false } },
                yPosition: { type: 'linear', display: false, reverse: true, min: 1, max: 100, grid: { drawOnChartArea: false } },
                x: { grid: { display: false }, ticks: { maxTicksLimit: 10, font: { size: 10 } } }
            }
        }
    });
}

// 7-day rolling chart
if (seoHasEnoughData && document.getElementById('chartSeo7d')) {
    new Chart(document.getElementById('chartSeo7d'), {
        type: 'line',
        data: {
            labels: seoChartLabels,
            datasets: [
                { label: 'Clics (cumul 7j)', data: seoChartClicks7d, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4, borderWidth: 2, pointRadius: 2, pointHoverRadius: 5, yAxisID: 'yClicks7d' },
                { label: 'Impressions (cumul 7j)', data: seoChartImpressions7d, borderColor: '#06b6d4', backgroundColor: 'rgba(6, 182, 212, 0.05)', fill: true, tension: 0.4, borderWidth: 2, pointRadius: 2, pointHoverRadius: 5, yAxisID: 'yImpressions7d' },
                { label: 'CTR moy. 7j (%)', data: seoChartCtr7d, borderColor: '#8b5cf6', backgroundColor: 'transparent', fill: false, tension: 0.4, borderWidth: 2, borderDash: [4, 4], pointRadius: 0, pointHoverRadius: 4, yAxisID: 'yCtr7d' },
                { label: 'Position moy. 7j', data: seoChartPosition7d, borderColor: '#f59e0b', backgroundColor: 'transparent', fill: false, tension: 0.4, borderWidth: 2, borderDash: [2, 2], pointRadius: 0, pointHoverRadius: 4, yAxisID: 'yPosition7d' }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 12, font: { size: 11 } } },
                tooltip: { callbacks: {
                    title: (items) => items.length > 0 ? 'Semaine se terminant le ' + items[0].label : '',
                    label: (ctx) => { let v = ctx.parsed.y; if (v === null) return null; if (ctx.dataset.label.includes('CTR')) return ctx.dataset.label + ': ' + v.toFixed(2) + '%'; if (ctx.dataset.label.includes('Position')) return ctx.dataset.label + ': ' + v.toFixed(1); return ctx.dataset.label + ': ' + v.toLocaleString('fr-FR'); }
                }}
            },
            scales: {
                yClicks7d: { type: 'linear', display: true, position: 'left', beginAtZero: true, title: { display: true, text: 'Clics (7j)', color: '#3b82f6', font: { size: 10 } }, ticks: { color: '#3b82f6', font: { size: 9 } }, grid: { color: 'rgba(0,0,0,0.05)' } },
                yImpressions7d: { type: 'linear', display: true, position: 'right', beginAtZero: true, title: { display: true, text: 'Impressions (7j)', color: '#06b6d4', font: { size: 10 } }, ticks: { color: '#06b6d4', font: { size: 9 } }, grid: { drawOnChartArea: false } },
                yCtr7d: { type: 'linear', display: false, beginAtZero: true, max: 10, grid: { drawOnChartArea: false } },
                yPosition7d: { type: 'linear', display: false, reverse: true, min: 1, max: 100, grid: { drawOnChartArea: false } },
                x: { grid: { display: false }, ticks: { maxTicksLimit: 10, font: { size: 10 } } }
            }
        }
    });
}

// Bouton "Fait" - marquer un mot-cle client comme optimise
document.querySelectorAll('.client-seo-mark-done').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var url = this.dataset.url;
        var token = this.dataset.token;
        var keywordId = this.dataset.keywordId;
        var row = document.getElementById('client-seo-improve-row-' + keywordId);
        var button = this;

        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: '_token=' + encodeURIComponent(token)
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                row.style.transition = 'opacity 0.3s';
                row.style.opacity = '0';
                setTimeout(function() { row.remove(); }, 300);
            } else {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-check"></i> Fait';
            }
        })
        .catch(function() {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-check"></i> Fait';
        });
    });
});
</script>
{% endif %}
{% endblock %}
