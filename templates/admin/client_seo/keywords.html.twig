{% extends '@EasyAdmin/page/content.html.twig' %}

{% block content_title %}
    <i class="fa fa-key"></i> Mots-cles - {{ site.name }}
{% endblock %}

{% block page_content %}
{% include 'admin/dashboard/_partials/_styles.html.twig' %}

<style>
    th.sortable { cursor: pointer; user-select: none; position: relative; }
    th.sortable:hover { color: #111827 !important; }
    th.sortable::after { content: ' \2195'; font-size: 0.65rem; opacity: 0.4; }
    th.sortable.asc::after { content: ' \2191'; opacity: 0.8; }
    th.sortable.desc::after { content: ' \2193'; opacity: 0.8; }
</style>

<div style="margin-bottom: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
    <a href="{{ path('admin_client_seo_dashboard', {id: site.id}) }}" class="btn btn-sm btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> Retour au dashboard
    </a>
</div>

{% set activeKeywords = keywords|filter(k => k.active) %}
{% set inactiveKeywords = keywords|filter(k => not k.active) %}

{% if activeKeywords|length == 0 and inactiveKeywords|length == 0 %}
<div class="stat-card info" style="text-align: center; padding: 3rem;">
    <i class="fas fa-key" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem; display: block;"></i>
    <div style="font-size: 1.125rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Aucun mot-cle</div>
    <div style="color: #6b7280;">Importez des donnees GSC pour voir apparaitre les mots-cles.</div>
</div>
{% else %}

<div class="chart-container" style="padding: 1rem 1.5rem; margin-bottom: 1.5rem;">
    <div class="chart-title" style="margin-bottom: 1rem;">
        <i class="fas fa-key" style="color: var(--primary);"></i>
        {{ activeKeywords|length }} mot{{ activeKeywords|length > 1 ? 's' : '' }}-cle{{ activeKeywords|length > 1 ? 's' : '' }} actif{{ activeKeywords|length > 1 ? 's' : '' }}
        {% if inactiveKeywords|length > 0 %}
            <span style="font-size: 0.75rem; font-weight: 400; color: #9ca3af; margin-left: 0.5rem;">(+ {{ inactiveKeywords|length }} inactif{{ inactiveKeywords|length > 1 ? 's' : '' }})</span>
        {% endif %}
    </div>
    <div style="overflow-x: auto;">
        <table id="active-keywords-table" style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
            <thead>
                <tr style="border-bottom: 2px solid #e5e7eb;">
                    <th class="sortable" data-sort="string" style="text-align: left; padding: 0.75rem 0.5rem; color: #374151; font-weight: 600;">Mot-cle</th>
                    <th class="sortable" data-sort="number" style="text-align: center; padding: 0.75rem 0.5rem; color: #374151; font-weight: 600;">Score</th>
                    <th class="sortable" data-sort="number" style="text-align: center; padding: 0.75rem 0.5rem; color: #374151; font-weight: 600;">Position</th>
                    <th class="sortable" data-sort="number" style="text-align: center; padding: 0.75rem 0.5rem; color: #374151; font-weight: 600;">Clics</th>
                    <th class="sortable" data-sort="number" style="text-align: center; padding: 0.75rem 0.5rem; color: #374151; font-weight: 600;">Impr.</th>
                    <th class="sortable" data-sort="number" style="text-align: center; padding: 0.75rem 0.5rem; color: #374151; font-weight: 600;">Dern. vue GSC</th>
                    <th class="sortable" data-sort="number" style="text-align: center; padding: 0.75rem 0.5rem; color: #374151; font-weight: 600;">Dern. optim.</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #374151; font-weight: 600;"></th>
                </tr>
            </thead>
            <tbody>
                {% for keyword in activeKeywords %}
                    {% set latestPosition = keyword.latestPosition %}
                    <tr style="border-bottom: 1px solid #f3f4f6;" id="keyword-row-{{ keyword.id }}">
                        <td data-sort-value="{{ keyword.keyword|lower }}" style="padding: 0.75rem 0.5rem; font-weight: 500;">{{ keyword.keyword }}</td>
                        <td data-sort-value="{{ keyword.relevanceScore }}" style="text-align: center; padding: 0.75rem 0.5rem;">
                            <span class="seo-star-group" data-score="{{ keyword.relevanceScore }}" data-url="{{ path('admin_client_seo_keyword_set_score', {id: keyword.id}) }}" data-token="{{ csrf_token('client-seo-score-' ~ keyword.id) }}" style="cursor: pointer; white-space: nowrap;">
                                {% for i in 1..5 %}
                                    <i class="{{ keyword.relevanceScore >= i ? 'fas' : 'far' }} fa-star seo-star" data-value="{{ i }}" style="color: {{ keyword.relevanceScore >= i ? '#f59e0b' : '#d1d5db' }}; font-size: 0.85rem;"></i>
                                {% endfor %}
                                {% if keyword.relevanceScore == 0 %}<span style="color: #d1d5db; font-size: 0.7rem; margin-left: 2px;">?</span>{% endif %}
                            </span>
                        </td>
                        <td data-sort-value="{{ latestPosition ? latestPosition.position : 999 }}" style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% if latestPosition %}
                                {% set pos = latestPosition.position %}
                                {% if pos <= 10 %}
                                    <span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">{{ pos|number_format(1) }}</span>
                                {% elseif pos <= 20 %}
                                    <span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">{{ pos|number_format(1) }}</span>
                                {% else %}
                                    <span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">{{ pos|number_format(1) }}</span>
                                {% endif %}
                            {% else %}
                                <span style="color: #9ca3af;">-</span>
                            {% endif %}
                        </td>
                        <td data-sort-value="{{ latestPosition ? latestPosition.clicks : -1 }}" style="text-align: center; padding: 0.75rem 0.5rem; font-weight: 600;">
                            {% if latestPosition %}{{ latestPosition.clicks }}{% else %}-{% endif %}
                        </td>
                        <td data-sort-value="{{ latestPosition ? latestPosition.impressions : -1 }}" style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% if latestPosition %}{{ latestPosition.impressions|number_format(0, '', ' ') }}{% else %}-{% endif %}
                        </td>
                        <td data-sort-value="{{ keyword.lastSeenInGsc ? keyword.lastSeenInGsc|date('U') : 0 }}" style="text-align: center; padding: 0.75rem 0.5rem; font-size: 0.8rem;">
                            {% if keyword.lastSeenInGsc %}
                                {% set daysSince = date().diff(keyword.lastSeenInGsc).days %}
                                <span style="color: {{ daysSince > 14 ? '#dc2626' : (daysSince > 7 ? '#d97706' : '#6b7280') }};">
                                    {{ keyword.lastSeenInGsc|date('d/m/Y') }}
                                </span>
                                {% if daysSince > 14 %}
                                    <div style="font-size: 0.65rem; color: #dc2626;">il y a {{ daysSince }}j</div>
                                {% endif %}
                            {% else %}
                                <span style="color: #d1d5db;">-</span>
                            {% endif %}
                        </td>
                        <td data-sort-value="{{ keyword.lastOptimizedAt ? keyword.lastOptimizedAt|date('U') : 0 }}" style="text-align: center; padding: 0.75rem 0.5rem; font-size: 0.8rem; color: #6b7280;">
                            {% if keyword.lastOptimizedAt %}
                                {{ keyword.lastOptimizedAt|date('d/m/Y') }}
                            {% else %}
                                <span style="color: #d1d5db;">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.25rem;">
                            <button class="btn-toggle-active" data-id="{{ keyword.id }}" data-url="{{ path('admin_client_seo_keyword_toggle_active', {id: keyword.id}) }}" data-token="{{ csrf_token('client-seo-toggle-' ~ keyword.id) }}" data-active="1" title="Desactiver ce mot-cle" style="background: none; border: none; cursor: pointer; padding: 0.25rem; color: #9ca3af; font-size: 0.8rem;">
                                <i class="fas fa-toggle-on" style="color: #10b981; font-size: 1.1rem;"></i>
                            </button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% if inactiveKeywords|length > 0 %}
<details style="margin-bottom: 1.5rem;">
    <summary style="cursor: pointer; font-size: 0.875rem; color: #6b7280; padding: 0.5rem;">
        <i class="fas fa-eye-slash"></i> {{ inactiveKeywords|length }} mot{{ inactiveKeywords|length > 1 ? 's' : '' }}-cle{{ inactiveKeywords|length > 1 ? 's' : '' }} inactif{{ inactiveKeywords|length > 1 ? 's' : '' }}
    </summary>
    <div class="chart-container" style="padding: 1rem 1.5rem; margin-top: 0.5rem;">
        <div style="overflow-x: auto;">
            <table id="inactive-keywords-table" style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                <thead>
                    <tr style="border-bottom: 2px solid #e5e7eb;">
                        <th class="sortable" data-sort="string" style="text-align: left; padding: 0.5rem; color: #9ca3af; font-weight: 600;">Mot-cle</th>
                        <th class="sortable" data-sort="number" style="text-align: center; padding: 0.5rem; color: #9ca3af; font-weight: 600;">Score</th>
                        <th class="sortable" data-sort="number" style="text-align: center; padding: 0.5rem; color: #9ca3af; font-weight: 600;">Dern. position</th>
                        <th class="sortable" data-sort="number" style="text-align: center; padding: 0.5rem; color: #9ca3af; font-weight: 600;">Dern. vue GSC</th>
                        <th class="sortable" data-sort="number" style="text-align: center; padding: 0.5rem; color: #9ca3af; font-weight: 600;">Desactive le</th>
                        <th style="text-align: center; padding: 0.5rem; color: #9ca3af; font-weight: 600;"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for keyword in inactiveKeywords %}
                        {% set latestPosition = keyword.latestPosition %}
                        <tr style="border-bottom: 1px solid #f3f4f6; opacity: 0.7;" id="keyword-row-{{ keyword.id }}">
                            <td data-sort-value="{{ keyword.keyword|lower }}" style="padding: 0.5rem; color: #9ca3af;">{{ keyword.keyword }}</td>
                            <td data-sort-value="{{ keyword.relevanceScore }}" style="text-align: center; padding: 0.5rem;">
                                <span class="seo-star-group" data-score="{{ keyword.relevanceScore }}" data-url="{{ path('admin_client_seo_keyword_set_score', {id: keyword.id}) }}" data-token="{{ csrf_token('client-seo-score-' ~ keyword.id) }}" style="cursor: pointer; white-space: nowrap;">
                                    {% for i in 1..5 %}
                                        <i class="{{ keyword.relevanceScore >= i ? 'fas' : 'far' }} fa-star seo-star" data-value="{{ i }}" style="color: {{ keyword.relevanceScore >= i ? '#f59e0b' : '#d1d5db' }}; font-size: 0.85rem;"></i>
                                    {% endfor %}
                                    {% if keyword.relevanceScore == 0 %}<span style="color: #d1d5db; font-size: 0.7rem; margin-left: 2px;">?</span>{% endif %}
                                </span>
                            </td>
                            <td data-sort-value="{{ latestPosition ? latestPosition.position : 999 }}" style="text-align: center; padding: 0.5rem;">
                                {% if latestPosition %}
                                    <span style="color: #9ca3af;">{{ latestPosition.position|number_format(1) }}</span>
                                {% else %}
                                    <span style="color: #d1d5db;">-</span>
                                {% endif %}
                            </td>
                            <td data-sort-value="{{ keyword.lastSeenInGsc ? keyword.lastSeenInGsc|date('U') : 0 }}" style="text-align: center; padding: 0.5rem; font-size: 0.8rem; color: #9ca3af;">
                                {% if keyword.lastSeenInGsc %}
                                    {{ keyword.lastSeenInGsc|date('d/m/Y') }}
                                {% else %}
                                    <span style="color: #d1d5db;">-</span>
                                {% endif %}
                            </td>
                            <td data-sort-value="{{ keyword.deactivatedAt ? keyword.deactivatedAt|date('U') : 0 }}" style="text-align: center; padding: 0.5rem; font-size: 0.8rem;">
                                {% if keyword.deactivatedAt %}
                                    <span style="color: #dc2626;">{{ keyword.deactivatedAt|date('d/m/Y') }}</span>
                                {% else %}
                                    <span style="color: #d1d5db;">manuel</span>
                                {% endif %}
                            </td>
                            <td style="text-align: center; padding: 0.5rem 0.25rem;">
                                <button class="btn-toggle-active" data-id="{{ keyword.id }}" data-url="{{ path('admin_client_seo_keyword_toggle_active', {id: keyword.id}) }}" data-token="{{ csrf_token('client-seo-toggle-' ~ keyword.id) }}" data-active="0" title="Reactiver ce mot-cle" style="background: none; border: none; cursor: pointer; padding: 0.25rem; font-size: 0.8rem;">
                                    <i class="fas fa-toggle-off" style="color: #9ca3af; font-size: 1.1rem;"></i>
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</details>
{% endif %}

{% endif %}

<script>
// Toggle active/inactive
document.querySelectorAll('.btn-toggle-active').forEach(btn => {
    btn.addEventListener('click', async function() {
        const url = this.dataset.url;
        const token = this.dataset.token;

        try {
            const formData = new FormData();
            formData.append('_token', token);

            const response = await fetch(url, { method: 'POST', body: formData });
            const data = await response.json();

            if (data.success) {
                window.location.reload();
            }
        } catch (e) {
            console.error('Erreur toggle:', e);
        }
    });
});

// Sortable table columns
document.querySelectorAll('th.sortable').forEach(th => {
    th.addEventListener('click', function() {
        const table = this.closest('table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const colIndex = Array.from(this.parentNode.children).indexOf(this);
        const sortType = this.dataset.sort; // 'string' or 'number'

        // Toggle direction
        const isAsc = this.classList.contains('asc');
        table.querySelectorAll('th.sortable').forEach(h => h.classList.remove('asc', 'desc'));
        this.classList.add(isAsc ? 'desc' : 'asc');
        const direction = isAsc ? -1 : 1;

        rows.sort((a, b) => {
            const cellA = a.children[colIndex];
            const cellB = b.children[colIndex];
            let valA = cellA.dataset.sortValue ?? cellA.textContent.trim();
            let valB = cellB.dataset.sortValue ?? cellB.textContent.trim();

            if (sortType === 'number') {
                valA = parseFloat(valA) || 0;
                valB = parseFloat(valB) || 0;
                return (valA - valB) * direction;
            }
            return valA.localeCompare(valB, 'fr') * direction;
        });

        rows.forEach(row => tbody.appendChild(row));
    });
});
</script>
{% endblock %}
