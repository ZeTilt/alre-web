{% extends '@EasyAdmin/page/content.html.twig' %}

{% block content_title %}
    <i class="fa fa-euro-sign"></i> Dashboard Finances {{ year }}
{% endblock %}

{% block content_header_wrapper %}
    {{ parent() }}
    <div style="margin-top: -40px; display: flex; justify-content: flex-end; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <form id="periodForm" method="GET" action="{{ path('admin_finance_dashboard') }}" style="display: flex; gap: 0.5rem; align-items: center;">
            <select name="period" id="periodSelect" class="form-select form-select-sm" style="width: auto;" onchange="handlePeriodChange()">
                {% for label, value in periodChoices %}
                    <option value="{{ value }}" {% if periodType == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            <div id="customDateFields" style="display: {{ periodType == 'custom' ? 'flex' : 'none' }}; gap: 0.5rem; align-items: center;">
                <input type="date" name="startDate" id="startDate" class="form-control form-control-sm" value="{{ customStartDate }}" style="width: auto;">
                <span>&rarr;</span>
                <input type="date" name="endDate" id="endDate" class="form-control form-control-sm" value="{{ customEndDate }}" style="width: auto;">
            </div>
            <button type="submit" class="btn btn-sm btn-primary">
                <i class="fas fa-sync"></i>
            </button>
        </form>
        <a href="{{ path('admin_dashboard_export_csv') }}" class="btn btn-sm btn-success">
            <i class="fas fa-file-csv"></i> Exporter CSV
        </a>
    </div>
{% endblock %}

{% block page_content %}
{% include 'admin/dashboard/_partials/_styles.html.twig' %}
{% include 'admin/dashboard/_partials/_nav_tabs.html.twig' with {active: 'finance'} %}

<!-- KPI Periode selectionnee -->
<div class="chart-container" style="padding: 1rem 1.5rem; margin-bottom: 1.5rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div>
            <div class="chart-title" style="margin-bottom: 0.25rem;">
                <i class="fas fa-calendar-alt" style="color: var(--primary);"></i>
                CA {{ periodLabel }}
            </div>
            <div style="font-size: 2rem; font-weight: 700; color: #111827;">
                {{ caPeriode|number_format(2, ',', ' ') }} &euro;
            </div>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 0.875rem; color: #6b7280; font-weight: 600;">vs N-1</div>
            {% if caPeriodeComparison > 0 %}
                <div style="font-size: 1.5rem; font-weight: 700; color: {% if variationPeriodePourcent >= 0 %}#10b981{% else %}#ef4444{% endif %};">
                    <i class="fas fa-arrow-{% if variationPeriodePourcent >= 0 %}up{% else %}down{% endif %}"></i>
                    {{ variationPeriodePourcent|abs }}%
                </div>
                <div style="font-size: 0.875rem; color: #9ca3af;">
                    {{ caPeriodeComparison|number_format(2, ',', ' ') }} &euro; N-1
                </div>
            {% else %}
                <div style="font-size: 1rem; color: #9ca3af;">Pas de donnees N-1</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- KPIs Principaux -->
<div class="dashboard-grid">
    <div class="stat-card primary">
        <div class="stat-header">
            <span class="stat-label">CA Ce Mois</span>
            <div class="stat-icon primary"><i class="fas fa-euro-sign"></i></div>
        </div>
        <div class="stat-value">{{ (caMoisEncaisse / 1000)|number_format(1) }}k&euro;</div>
        {% if variationMoisPourcent != 0 %}
            <div class="stat-subtitle {% if variationMoisPourcent > 0 %}positive{% else %}negative{% endif %}">
                <i class="fas fa-arrow-{% if variationMoisPourcent > 0 %}up{% else %}down{% endif %}"></i>
                {{ variationMoisPourcent|abs }}% vs mois dernier
            </div>
        {% endif %}
    </div>

    <div class="stat-card success">
        <div class="stat-header">
            <span class="stat-label">CA Annee {{ year }}</span>
            <div class="stat-icon success"><i class="fas fa-chart-line"></i></div>
        </div>
        <div class="stat-value">{{ (caAnneeEncaisse / 1000)|number_format(1) }}k&euro;</div>
        {% if objectifAnnuel > 0 %}
            <div class="stat-subtitle">{{ progressionObjectifAnnuel }}% de l'objectif</div>
        {% endif %}
    </div>

    <div class="stat-card {% if progressionPlafond >= 90 %}danger{% elseif progressionPlafond >= 75 %}warning{% else %}info{% endif %}">
        <div class="stat-header">
            <span class="stat-label">Plafond AE</span>
            <div class="stat-icon {% if progressionPlafond >= 90 %}danger{% elseif progressionPlafond >= 75 %}warning{% else %}info{% endif %}">
                <i class="fas fa-gauge-high"></i>
            </div>
        </div>
        <div class="stat-value">{{ progressionPlafond }}%</div>
        <div class="stat-subtitle">{{ (caAnneeEncaisse / 1000)|number_format(0) }}k&euro; / {{ (plafondCa / 1000)|number_format(0) }}k&euro;</div>
    </div>

    <div class="stat-card warning">
        <div class="stat-header">
            <span class="stat-label">En Attente</span>
            <div class="stat-icon warning"><i class="fas fa-clock"></i></div>
        </div>
        <div class="stat-value">{{ (caEnAttente / 1000)|number_format(1) }}k&euro;</div>
        <div class="stat-subtitle">{{ nbFacturesEnRetard + nbDevisPending }} factures/devis</div>
    </div>

    {% if tauxCotisations > 0 %}
    <div class="stat-card purple">
        <div class="stat-header">
            <span class="stat-label">Cotisations URSSAF</span>
            <div class="stat-icon purple"><i class="fas fa-landmark"></i></div>
        </div>
        <div class="stat-value">{{ (cotisationsEstimees / 1000)|number_format(1) }}k&euro;</div>
        <div class="stat-subtitle">{{ tauxCotisations }}% du CA</div>
    </div>
    {% endif %}

    <div class="stat-card info">
        <div class="stat-header">
            <span class="stat-label">Taux Conversion</span>
            <div class="stat-icon info"><i class="fas fa-percent"></i></div>
        </div>
        <div class="stat-value">{{ tauxConversion }}%</div>
        <div class="stat-subtitle">Devis &rarr; Factures</div>
    </div>

    <div class="stat-card {% if margeNetAnnee >= 30 %}success{% elseif margeNetAnnee >= 15 %}warning{% else %}danger{% endif %}">
        <div class="stat-header">
            <span class="stat-label">Benefice Net {{ year }}</span>
            <div class="stat-icon {% if margeNetAnnee >= 30 %}success{% elseif margeNetAnnee >= 15 %}warning{% else %}danger{% endif %}">
                <i class="fas fa-chart-line"></i>
            </div>
        </div>
        <div class="stat-value">{{ (beneficeNetAnnee / 1000)|number_format(1) }}k&euro;</div>
        <div class="stat-subtitle">Apres cotisations URSSAF : {{ margeNetAnnee }}%</div>
    </div>
</div>

<!-- Alertes -->
{% if nbFacturesEnRetard > 0 or nbDevisARelancer > 0 %}
<div style="margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
    {% if nbFacturesEnRetard > 0 %}
        <div class="alert-badge danger">
            <i class="fas fa-exclamation-circle"></i>
            {{ nbFacturesEnRetard }} facture(s) en retard ({{ (montantEnRetard / 1000)|number_format(1) }}k&euro;)
        </div>
    {% endif %}
    {% if nbDevisARelancer > 0 %}
        <div class="alert-badge warning">
            <i class="fas fa-bell"></i>
            {{ nbDevisARelancer }} devis a relancer
        </div>
    {% endif %}
</div>
{% endif %}

<!-- Previsions -->
{% if projections is not empty %}
<div class="chart-container" style="padding: 1rem 1.5rem;">
    <div class="chart-title" style="margin-bottom: 0.5rem;">
        <i class="fas fa-crystal-ball" style="color: var(--purple);"></i>
        Previsions CA (moyenne 3 derniers mois)
    </div>
    <div style="display: flex; gap: 1.5rem; align-items: center; flex-wrap: wrap;">
        {% for proj in projections %}
            <div style="flex: 1; min-width: 150px;">
                <div style="font-size: 0.875rem; color: #6b7280; font-weight: 600;">{{ proj.month }}</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #3b82f6;">{{ (proj.amount / 1000)|number_format(1) }}k&euro;</div>
            </div>
        {% endfor %}
        {% if tendance != 0 %}
            <div style="flex: 1; min-width: 150px; padding: 0.75rem; background: {% if tendance > 0 %}#f0fdf4{% else %}#fef2f2{% endif %}; border-radius: 8px;">
                <div style="font-size: 0.875rem; color: #6b7280; font-weight: 600;">Tendance</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: {% if tendance > 0 %}#10b981{% else %}#ef4444{% endif %};">
                    <i class="fas fa-arrow-{% if tendance > 0 %}up{% else %}down{% endif %}"></i> {{ tendance|abs }}%
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Graphiques -->
<div class="grid-2">
    <!-- Evolution CA Mensuel -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-chart-area" style="color: var(--primary);"></i>
            Evolution CA - {{ periodLabel }}
        </div>
        <canvas id="chartCAMensuel" class="chart-canvas"></canvas>
    </div>

    <!-- Top Clients -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-chart-pie" style="color: var(--success);"></i>
            Top 5 Clients - {{ periodLabel }}
        </div>
        <canvas id="chartClients" class="chart-canvas"></canvas>
    </div>
</div>

<!-- CA, Cotisations et Benefice -->
<div class="chart-container">
    <div class="chart-title">
        <i class="fas fa-chart-bar" style="color: var(--info);"></i>
        CA, Cotisations URSSAF et Benefice Net - {{ periodLabel }}
    </div>
    <canvas id="chartComparaison" class="chart-canvas"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Toggle custom date fields
function handlePeriodChange() {
    const select = document.getElementById('periodSelect');
    const customFields = document.getElementById('customDateFields');
    if (select.value === 'custom') {
        customFields.style.display = 'flex';
    } else {
        customFields.style.display = 'none';
    }
}

// Configuration commune
Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
Chart.defaults.plugins.legend.display = true;
Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(17, 24, 39, 0.95)';
Chart.defaults.plugins.tooltip.padding = 12;
Chart.defaults.plugins.tooltip.cornerRadius = 8;

// Donnees PHP -> JS
const caParMois = {{ caParMois|json_encode|raw }};
const caParMoisComparison = {{ caParMoisComparison|json_encode|raw }};
const cotisationsParMois = {{ cotisationsParMois|json_encode|raw }};
const topClients = {{ topClients|json_encode|raw }};
const monthLabels = {{ monthLabels|json_encode|raw }};

// 1. Graphique Evolution CA Mensuel
const hasComparisonData = caParMoisComparison.some(v => v > 0);

new Chart(document.getElementById('chartCAMensuel'), {
    type: 'line',
    data: {
        labels: monthLabels,
        datasets: [
            {
                label: 'CA Encaisse',
                data: caParMois,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 4,
                pointHoverRadius: 6
            },
            ...(hasComparisonData ? [{
                label: 'N-1',
                data: caParMoisComparison,
                borderColor: '#9ca3af',
                backgroundColor: 'transparent',
                borderDash: [5, 5],
                fill: false,
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 2,
                pointHoverRadius: 4
            }] : [])
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: hasComparisonData },
            tooltip: {
                callbacks: {
                    label: (ctx) => ctx.dataset.label + ': ' + ctx.parsed.y.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })
                }
            }
        },
        scales: {
            y: { beginAtZero: true, ticks: { callback: (value) => (value / 1000) + 'k\u20AC' }, grid: { color: 'rgba(0,0,0,0.05)' } },
            x: { grid: { display: false } }
        }
    }
});

// 2. Graphique Top Clients (Camembert)
const clientColors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
new Chart(document.getElementById('chartClients'), {
    type: 'doughnut',
    data: {
        labels: topClients.map(c => c.clientName),
        datasets: [{
            data: topClients.map(c => parseFloat(c.total)),
            backgroundColor: clientColors,
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'bottom', labels: { padding: 15, font: { size: 11 } } },
            tooltip: {
                callbacks: {
                    label: (ctx) => {
                        const total = topClients.reduce((sum, c) => sum + parseFloat(c.total), 0);
                        const percent = Math.round((ctx.parsed / total) * 100);
                        return ctx.label + ': ' + ctx.parsed.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' }) + ' (' + percent + '%)';
                    }
                }
            }
        }
    }
});

// 3. Graphique CA vs Cotisations (Barres)
new Chart(document.getElementById('chartComparaison'), {
    type: 'bar',
    data: {
        labels: monthLabels,
        datasets: [
            {
                label: 'CA Encaisse',
                data: caParMois,
                backgroundColor: 'rgba(16, 185, 129, 0.7)',
                borderColor: '#10b981',
                borderWidth: 1
            },
            {
                label: 'Cotisations URSSAF',
                data: cotisationsParMois,
                backgroundColor: 'rgba(245, 158, 11, 0.7)',
                borderColor: '#f59e0b',
                borderWidth: 1
            },
            {
                label: 'Benefice Net',
                data: caParMois.map((ca, index) => {
                    const cotisations = cotisationsParMois[index] || 0;
                    return ca - cotisations;
                }),
                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                borderColor: '#3b82f6',
                borderWidth: 1
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'top', labels: { padding: 15, usePointStyle: true } },
            tooltip: {
                callbacks: {
                    label: (ctx) => ctx.dataset.label + ': ' + ctx.parsed.y.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })
                }
            }
        },
        scales: {
            y: { beginAtZero: true, ticks: { callback: (value) => (value / 1000) + 'k\u20AC' }, grid: { color: 'rgba(0,0,0,0.05)' } },
            x: { grid: { display: false } }
        }
    }
});
</script>
{% endblock %}
