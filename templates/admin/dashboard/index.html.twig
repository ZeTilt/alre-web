{% extends '@EasyAdmin/page/content.html.twig' %}

{% block content_title %}
    <i class="fa fa-chart-line"></i> Tableau de Bord {{ year }}
{% endblock %}

{% block content_header_wrapper %}
    {{ parent() }}
    <div style="margin-top: -40px; display: flex; justify-content: flex-end; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <form id="periodForm" method="GET" action="{{ path('admin_business_dashboard') }}" style="display: flex; gap: 0.5rem; align-items: center;">
            <select name="period" id="periodSelect" class="form-select form-select-sm" style="width: auto;" onchange="handlePeriodChange()">
                {% for label, value in periodChoices %}
                    <option value="{{ value }}" {% if periodType == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            <div id="customDateFields" style="display: {{ periodType == 'custom' ? 'flex' : 'none' }}; gap: 0.5rem; align-items: center;">
                <input type="date" name="startDate" id="startDate" class="form-control form-control-sm" value="{{ customStartDate }}" style="width: auto;">
                <span>→</span>
                <input type="date" name="endDate" id="endDate" class="form-control form-control-sm" value="{{ customEndDate }}" style="width: auto;">
            </div>
            <button type="submit" class="btn btn-sm btn-primary">
                <i class="fas fa-sync"></i>
            </button>
        </form>
        <a href="{{ path('admin_dashboard_export_csv') }}" class="btn btn-sm btn-success">
            <i class="fas fa-file-csv"></i> Exporter CSV
        </a>
    </div>
{% endblock %}

{% block page_content %}
<style>
    :root {
        --primary: #3b82f6;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #06b6d4;
        --purple: #8b5cf6;
    }
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.25rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border-left: 4px solid var(--primary);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .stat-card.success { border-left-color: var(--success); }
    .stat-card.warning { border-left-color: var(--warning); }
    .stat-card.danger { border-left-color: var(--danger); }
    .stat-card.info { border-left-color: var(--info); }
    .stat-card.purple { border-left-color: var(--purple); }
    .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    .stat-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }
    .stat-icon.primary { background: #eff6ff; color: var(--primary); }
    .stat-icon.success { background: #f0fdf4; color: var(--success); }
    .stat-icon.warning { background: #fffbeb; color: var(--warning); }
    .stat-icon.danger { background: #fef2f2; color: var(--danger); }
    .stat-icon.info { background: #f0fdfa; color: var(--info); }
    .stat-icon.purple { background: #faf5ff; color: var(--purple); }
    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #111827;
        margin: 0.5rem 0;
    }
    .stat-subtitle {
        font-size: 0.875rem;
        color: #9ca3af;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    .stat-subtitle.positive { color: var(--success); }
    .stat-subtitle.negative { color: var(--danger); }
    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
        height: 350px;
    }
    .chart-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .chart-canvas {
        max-height: 280px;
    }
    .progress-ring {
        width: 80px;
        height: 80px;
        position: relative;
    }
    .progress-ring svg {
        transform: rotate(-90deg);
    }
    .progress-ring circle {
        fill: none;
        stroke-width: 8;
    }
    .alert-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
    }
    .alert-badge.danger { background: #fef2f2; color: var(--danger); }
    .alert-badge.warning { background: #fffbeb; color: var(--warning); }
    .alert-badge.success { background: #f0fdf4; color: var(--success); }
    .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }
    @media (max-width: 768px) {
        .grid-2 { grid-template-columns: 1fr; }
    }

    {% if demoMode %}
    /* Mode démo : flouter les données sensibles */
    .stat-value,
    .stat-subtitle,
    .alert-badge {
        filter: blur(4px);
        transition: filter 0.2s;
    }
    .stat-card:hover .stat-value,
    .stat-card:hover .stat-subtitle,
    .stat-card:hover .alert-badge {
        filter: blur(0px);
    }
    {% endif %}
</style>

<!-- Google Search Console Status -->
<div class="stat-card {% if googleOAuthConnected %}success{% elseif googleOAuthConfigured %}info{% else %}warning{% endif %}" style="margin-bottom: 1.5rem;">
    <div class="stat-header">
        <span class="stat-label">Google Search Console</span>
        <div class="stat-icon {% if googleOAuthConnected %}success{% elseif googleOAuthConfigured %}info{% else %}warning{% endif %}">
            <i class="fab fa-google"></i>
        </div>
    </div>
    {% if not googleOAuthConfigured %}
        <div style="color: #92400e; font-size: 0.875rem;">
            <i class="fas fa-exclamation-triangle"></i>
            Credentials non configurés. Ajoutez <code>GOOGLE_CLIENT_ID</code> et <code>GOOGLE_CLIENT_SECRET</code> dans le fichier <code>.env.local</code>
        </div>
    {% elseif googleOAuthConnected %}
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <span style="color: #065f46; font-weight: 600;">
                    <i class="fas fa-check-circle"></i> Connecté
                </span>
                {% if googleOAuthToken %}
                    <div style="font-size: 0.75rem; margin-top: 0.25rem;">
                        {% if googleOAuthToken.isExpiringSoon(5) %}
                            <span style="color: #f59e0b;">
                                <i class="fas fa-exclamation-triangle"></i>
                                Token expire bientôt (sera rafraîchi automatiquement)
                            </span>
                        {% elseif googleOAuthToken.isExpired %}
                            <span style="color: #ef4444;">
                                <i class="fas fa-times-circle"></i>
                                Token expiré - sera rafraîchi au prochain appel API
                            </span>
                        {% else %}
                            <span style="color: #6b7280;">
                                Expire le {{ googleOAuthToken.expiresAt|date('d/m/Y à H:i') }}
                            </span>
                        {% endif %}
                    </div>
                {% endif %}
                {% if lastSeoSyncAt %}
                    <div style="font-size: 0.75rem; margin-top: 0.25rem; color: #6b7280;">
                        <i class="fas fa-sync-alt"></i> Dernière sync SEO: {{ lastSeoSyncAt|date('d/m/Y à H:i') }}
                    </div>
                {% endif %}
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <a href="{{ path('admin_google_sync_seo') }}" class="btn btn-sm btn-primary" title="Synchroniser les positions SEO">
                    <i class="fas fa-sync-alt"></i> Sync SEO
                </a>
                <a href="{{ path('admin_google_disconnect') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-unlink"></i> Déconnecter
                </a>
            </div>
        </div>
    {% else %}
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #6b7280;">Non connecté</div>
            <a href="{{ path('admin_google_connect') }}" class="btn btn-sm btn-primary">
                <i class="fab fa-google"></i> Connecter Google Search Console
            </a>
        </div>
    {% endif %}
</div>

<!-- Google Reviews Widget -->
<div class="stat-card {% if googlePlacesConfigured %}{% if reviewStats.total > 0 %}success{% else %}info{% endif %}{% else %}warning{% endif %}" style="margin-bottom: 1.5rem;">
    <div class="stat-header">
        <span class="stat-label">Avis Google</span>
        <div class="stat-icon {% if googlePlacesConfigured %}{% if reviewStats.total > 0 %}success{% else %}info{% endif %}{% else %}warning{% endif %}">
            <i class="fas fa-star"></i>
        </div>
    </div>
    {% if not googlePlacesConfigured %}
        <div style="color: #92400e; font-size: 0.875rem;">
            <i class="fas fa-exclamation-triangle"></i>
            API non configurée. Ajoutez <code>GOOGLE_PLACES_API_KEY</code> et <code>GOOGLE_PLACE_ID</code> dans le fichier <code>.env.local</code>
        </div>
    {% elseif reviewStats.total > 0 %}
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div style="display: flex; gap: 2rem; align-items: center; flex-wrap: wrap;">
                <!-- Note moyenne -->
                <div>
                    <div style="font-size: 2rem; font-weight: 700; color: #f59e0b; display: flex; align-items: center; gap: 0.5rem;">
                        {{ reviewStats.averageRating|number_format(1, ',', ' ') }}
                        <i class="fas fa-star" style="font-size: 1.5rem;"></i>
                    </div>
                    <div style="font-size: 0.75rem; color: #6b7280;">Note moyenne</div>
                </div>
                <!-- Compteurs -->
                <div style="display: flex; gap: 1.5rem;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.25rem; font-weight: 700; color: #10b981;">{{ reviewStats.approved }}</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">Approuvés</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.25rem; font-weight: 700; color: #f59e0b;">{{ reviewStats.pending }}</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">En attente</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.25rem; font-weight: 700; color: #6b7280;">{{ reviewStats.total }}</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">Total</div>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                {% if not reviewsDataFresh %}
                    <span style="font-size: 0.75rem; color: #6b7280;">
                        <i class="fas fa-clock"></i> Données &gt; 12h
                    </span>
                {% endif %}
                <a href="{{ path('admin_reviews_sync') }}" class="btn btn-sm btn-primary" title="Synchroniser les avis Google">
                    <i class="fas fa-sync-alt"></i> Sync Avis
                </a>
                <a href="{{ ea_url().setController('App\\Controller\\Admin\\GoogleReviewCrudController').setAction('index') }}" class="btn btn-sm btn-outline-secondary" title="Gérer les avis">
                    <i class="fas fa-cog"></i>
                </a>
            </div>
        </div>
        {% if pendingReviews|length > 0 %}
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                <div style="font-size: 0.875rem; font-weight: 600; color: #92400e; margin-bottom: 0.5rem;">
                    <i class="fas fa-bell"></i> {{ pendingReviews|length }} avis en attente de modération
                </div>
                {% for review in pendingReviews|slice(0, 3) %}
                    <div style="background: #fffbeb; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <div style="font-weight: 500;">{{ review.authorName }}</div>
                                <div style="color: #f59e0b;">
                                    {% for i in 1..5 %}
                                        <i class="fas fa-star{% if i > review.rating %}-o{% endif %}" style="font-size: 0.75rem;"></i>
                                    {% endfor %}
                                </div>
                            </div>
                            <div style="font-size: 0.75rem; color: #6b7280;">{{ review.reviewDate|date('d/m/Y') }}</div>
                        </div>
                        {% if review.comment %}
                            <div style="font-size: 0.875rem; color: #4b5563; margin-top: 0.5rem; font-style: italic;">
                                "{{ review.commentExcerpt(100) }}"
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% else %}
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #6b7280;">Aucun avis synchronisé</div>
            <a href="{{ path('admin_reviews_sync') }}" class="btn btn-sm btn-primary">
                <i class="fas fa-sync-alt"></i> Synchroniser les avis
            </a>
        </div>
    {% endif %}
</div>

<!-- SEO Positions Widget -->
{% if googleOAuthConnected and seoKeywords|length > 0 %}
<div class="chart-container" style="padding: 1rem 1.5rem; margin-bottom: 1.5rem;">
    <div class="chart-title" style="margin-bottom: 1rem;">
        <i class="fas fa-search" style="color: var(--primary);"></i>
        Positions SEO
        <span style="font-size: 0.75rem; font-weight: 400; color: #6b7280; margin-left: 0.5rem;">
            ({{ seoKeywords|length }} mot{% if seoKeywords|length > 1 %}s{% endif %}-clé{% if seoKeywords|length > 1 %}s{% endif %})
        </span>
    </div>
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
            <thead>
                <tr style="border-bottom: 2px solid #e5e7eb;">
                    <th style="text-align: left; padding: 0.75rem 0.5rem; color: #6b7280; font-weight: 600;">Mot-clé</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #6b7280; font-weight: 600;">Position</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #6b7280; font-weight: 600;">vs M-1</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #6b7280; font-weight: 600;">Clics</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #6b7280; font-weight: 600;">Impressions</th>
                    <th style="text-align: right; padding: 0.75rem 0.5rem; color: #6b7280; font-weight: 600;">Dernière sync</th>
                </tr>
            </thead>
            <tbody>
                {% for keyword in seoKeywords %}
                    {% set latestPosition = keyword.latestPosition %}
                    {% set comparison = seoPositionComparisons[keyword.id] ?? null %}
                    <tr style="border-bottom: 1px solid #f3f4f6;">
                        <td style="padding: 0.75rem 0.5rem; font-weight: 500;">
                            {{ keyword.keyword }}
                            {% if not keyword.active %}
                                <span style="font-size: 0.625rem; background: #9ca3af; color: white; padding: 0.125rem 0.375rem; border-radius: 4px; margin-left: 0.5rem;">Inactif</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% if latestPosition %}
                                {% set pos = latestPosition.position %}
                                {% if pos <= 10 %}
                                    <span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">
                                        {{ pos|number_format(1) }}
                                    </span>
                                {% elseif pos <= 20 %}
                                    <span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">
                                        {{ pos|number_format(1) }}
                                    </span>
                                {% else %}
                                    <span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">
                                        {{ pos|number_format(1) }}
                                    </span>
                                {% endif %}
                            {% else %}
                                <span style="color: #9ca3af; font-style: italic;">Pas de données</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% if comparison %}
                                {% if comparison.status == 'improved' %}
                                    <span style="color: #10b981; font-weight: 600;">
                                        <i class="fas fa-arrow-up"></i> +{{ comparison.variation|abs|number_format(1) }}
                                    </span>
                                {% elseif comparison.status == 'degraded' %}
                                    <span style="color: #ef4444; font-weight: 600;">
                                        <i class="fas fa-arrow-down"></i> {{ comparison.variation|number_format(1) }}
                                    </span>
                                {% elseif comparison.status == 'stable' %}
                                    <span style="color: #6b7280;">=</span>
                                {% elseif comparison.status == 'new' %}
                                    <span style="background: #dbeafe; color: #1d4ed8; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Nouveau</span>
                                {% else %}
                                    <span style="color: #9ca3af;">-</span>
                                {% endif %}
                            {% else %}
                                <span style="color: #9ca3af;">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% if latestPosition %}
                                <span style="font-weight: 600;">{{ latestPosition.clicks }}</span>
                            {% else %}
                                <span style="color: #9ca3af;">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% if latestPosition %}
                                {{ latestPosition.impressions|number_format(0, '', ' ') }}
                            {% else %}
                                <span style="color: #9ca3af;">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: right; padding: 0.75rem 0.5rem; color: #6b7280; font-size: 0.75rem;">
                            {% if keyword.lastSyncAt %}
                                {{ keyword.lastSyncAt|date('d/m/Y H:i') }}
                            {% else %}
                                <span style="font-style: italic;">Jamais</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if seoKeywords|length > 0 %}
        <div style="margin-top: 1rem; display: flex; justify-content: space-between; align-items: center;">
            <a href="{{ ea_url().setController('App\\Controller\\Admin\\SeoKeywordCrudController').setAction('index') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-cog"></i> Gérer les mots-clés
            </a>
            {% if googleOAuthConnected %}
                <a href="{{ path('admin_google_sync_seo') }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-sync-alt"></i> Synchroniser
                </a>
            {% endif %}
        </div>
    {% endif %}
</div>
{% elseif googleOAuthConnected %}
<div class="stat-card info" style="margin-bottom: 1.5rem;">
    <div class="stat-header">
        <span class="stat-label">Positions SEO</span>
        <div class="stat-icon info"><i class="fas fa-search"></i></div>
    </div>
    <div style="color: #6b7280; font-size: 0.875rem;">
        Aucun mot-clé configuré.
        <a href="{{ ea_url().setController('App\\Controller\\Admin\\SeoKeywordCrudController').setAction('new') }}" style="color: var(--primary); text-decoration: underline;">
            Ajouter des mots-clés
        </a>
        pour commencer le suivi SEO.
    </div>
</div>
{% endif %}

<!-- SEO Evolution Chart (Clics/Impressions) -->
{% if googleOAuthConnected and seoKeywords|length > 0 %}
<div class="chart-container" style="margin-bottom: 1.5rem;">
    <div class="chart-title">
        <i class="fas fa-chart-line" style="color: var(--info);"></i>
        Évolution SEO - 30 derniers jours
    </div>
    {% if seoChartData.hasEnoughData %}
        <canvas id="chartSeoEvolution" class="chart-canvas"></canvas>
    {% else %}
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; color: #6b7280;">
            <i class="fas fa-chart-line" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
            <div style="font-size: 0.875rem; text-align: center;">
                Données insuffisantes pour afficher les tendances<br>
                <span style="font-size: 0.75rem; opacity: 0.7;">({{ seoChartData.daysWithData }} jour{% if seoChartData.daysWithData > 1 %}s{% endif %} de données, minimum 7 requis)</span>
            </div>
        </div>
    {% endif %}
</div>

<!-- SEO Performance Categories -->
<div class="grid-2" style="margin-bottom: 1.5rem;">
    <!-- Top Performers -->
    <div class="chart-container" style="height: auto; padding: 1.25rem;">
        <div class="chart-title" style="margin-bottom: 1rem;">
            <i class="fas fa-trophy" style="color: var(--success);"></i>
            Top Performers
            <span style="font-size: 0.75rem; font-weight: 400; color: #6b7280; margin-left: 0.5rem;">(Position &le; 10)</span>
        </div>
        {% if seoPerformanceData.topPerformers|length > 0 %}
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                {% for item in seoPerformanceData.topPerformers %}
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f0fdf4; border-radius: 8px;">
                        <div style="font-weight: 500; font-size: 0.875rem;">{{ item.keyword }}</div>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="background: #d1fae5; color: #065f46; padding: 0.125rem 0.5rem; border-radius: 9999px; font-weight: 700; font-size: 0.75rem;">
                                #{{ item.position|number_format(0) }}
                            </span>
                            <span style="color: #6b7280; font-size: 0.75rem;">{{ item.clicks }} clics</span>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; color: #6b7280;">
                <i class="fas fa-trophy" style="font-size: 2rem; opacity: 0.3; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 0.875rem; text-align: center;">Aucun mot-clé en première page encore</div>
            </div>
        {% endif %}
    </div>

    <!-- À améliorer -->
    <div class="chart-container" style="height: auto; padding: 1.25rem;">
        <div class="chart-title" style="margin-bottom: 1rem;">
            <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>
            À améliorer
            <span style="font-size: 0.75rem; font-weight: 400; color: #6b7280; margin-left: 0.5rem;">(Position &gt; 20)</span>
        </div>
        {% if seoPerformanceData.toImprove|length > 0 %}
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                {% for item in seoPerformanceData.toImprove %}
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #fef2f2; border-radius: 8px;">
                        <div style="font-weight: 500; font-size: 0.875rem;">{{ item.keyword }}</div>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="background: #fee2e2; color: #991b1b; padding: 0.125rem 0.5rem; border-radius: 9999px; font-weight: 700; font-size: 0.75rem;">
                                #{{ item.position|number_format(0) }}
                            </span>
                            <span style="color: #6b7280; font-size: 0.75rem;">{{ item.impressions|number_format(0, '', ' ') }} imp.</span>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; color: #6b7280;">
                <i class="fas fa-check-circle" style="font-size: 2rem; opacity: 0.3; color: #10b981; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 0.875rem; text-align: center;">Tous vos mots-clés sont bien positionnés</div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Opportunités CTR -->
{% if seoPerformanceData.ctrOpportunities|length > 0 %}
<div class="chart-container" style="height: auto; padding: 1.25rem; margin-bottom: 1.5rem;">
    <div class="chart-title" style="margin-bottom: 1rem;">
        <i class="fas fa-lightbulb" style="color: var(--warning);"></i>
        Opportunités CTR
        <span style="font-size: 0.75rem; font-weight: 400; color: #6b7280; margin-left: 0.5rem;">(Beaucoup d'impressions, peu de clics)</span>
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 0.75rem;">
        {% for item in seoPerformanceData.ctrOpportunities %}
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #fffbeb; border-radius: 8px; border-left: 3px solid #f59e0b;">
                <div>
                    <div style="font-weight: 500; font-size: 0.875rem;">{{ item.keyword }}</div>
                    <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                        {{ item.impressions|number_format(0, '', ' ') }} impressions
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 700; font-size: 0.875rem;">
                        CTR {{ item.ctr }}%
                    </div>
                    <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                        {{ item.clicks }} clics
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
    <div style="margin-top: 0.75rem; font-size: 0.75rem; color: #6b7280;">
        <i class="fas fa-info-circle"></i> Ces mots-clés génèrent des impressions mais peu de clics. Améliorez vos meta descriptions et titres pour augmenter le CTR.
    </div>
</div>
{% endif %}
{% endif %}

<!-- KPI Période sélectionnée -->
<div class="chart-container" style="padding: 1rem 1.5rem; margin-bottom: 1.5rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div>
            <div class="chart-title" style="margin-bottom: 0.25rem;">
                <i class="fas fa-calendar-alt" style="color: var(--primary);"></i>
                CA {{ periodLabel }}
            </div>
            <div style="font-size: 2rem; font-weight: 700; color: #111827;">
                {{ caPeriode|number_format(2, ',', ' ') }} €
            </div>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 0.875rem; color: #6b7280; font-weight: 600;">vs N-1</div>
            {% if caPeriodeComparison > 0 %}
                <div style="font-size: 1.5rem; font-weight: 700; color: {% if variationPeriodePourcent >= 0 %}#10b981{% else %}#ef4444{% endif %};">
                    <i class="fas fa-arrow-{% if variationPeriodePourcent >= 0 %}up{% else %}down{% endif %}"></i>
                    {{ variationPeriodePourcent|abs }}%
                </div>
                <div style="font-size: 0.875rem; color: #9ca3af;">
                    {{ caPeriodeComparison|number_format(2, ',', ' ') }} € N-1
                </div>
            {% else %}
                <div style="font-size: 1rem; color: #9ca3af;">Pas de données N-1</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- KPIs Principaux -->
<div class="dashboard-grid">
    <div class="stat-card primary">
        <div class="stat-header">
            <span class="stat-label">CA Ce Mois</span>
            <div class="stat-icon primary"><i class="fas fa-euro-sign"></i></div>
        </div>
        <div class="stat-value">{{ (caMoisEncaisse / 1000)|number_format(1) }}k€</div>
        {% if variationMoisPourcent != 0 %}
            <div class="stat-subtitle {% if variationMoisPourcent > 0 %}positive{% else %}negative{% endif %}">
                <i class="fas fa-arrow-{% if variationMoisPourcent > 0 %}up{% else %}down{% endif %}"></i>
                {{ variationMoisPourcent|abs }}% vs mois dernier
            </div>
        {% endif %}
    </div>

    <div class="stat-card success">
        <div class="stat-header">
            <span class="stat-label">CA Année {{ year }}</span>
            <div class="stat-icon success"><i class="fas fa-chart-line"></i></div>
        </div>
        <div class="stat-value">{{ (caAnneeEncaisse / 1000)|number_format(1) }}k€</div>
        {% if objectifAnnuel > 0 %}
            <div class="stat-subtitle">{{ progressionObjectifAnnuel }}% de l'objectif</div>
        {% endif %}
    </div>

    <div class="stat-card {% if progressionPlafond >= 90 %}danger{% elseif progressionPlafond >= 75 %}warning{% else %}info{% endif %}">
        <div class="stat-header">
            <span class="stat-label">Plafond AE</span>
            <div class="stat-icon {% if progressionPlafond >= 90 %}danger{% elseif progressionPlafond >= 75 %}warning{% else %}info{% endif %}">
                <i class="fas fa-gauge-high"></i>
            </div>
        </div>
        <div class="stat-value">{{ progressionPlafond }}%</div>
        <div class="stat-subtitle">{{ (caAnneeEncaisse / 1000)|number_format(0) }}k€ / {{ (plafondCa / 1000)|number_format(0) }}k€</div>
    </div>

    <div class="stat-card warning">
        <div class="stat-header">
            <span class="stat-label">En Attente</span>
            <div class="stat-icon warning"><i class="fas fa-clock"></i></div>
        </div>
        <div class="stat-value">{{ (caEnAttente / 1000)|number_format(1) }}k€</div>
        <div class="stat-subtitle">{{ nbFacturesEnRetard + nbDevisPending }} factures/devis</div>
    </div>

    {% if tauxCotisations > 0 %}
    <div class="stat-card purple">
        <div class="stat-header">
            <span class="stat-label">Cotisations URSSAF</span>
            <div class="stat-icon purple"><i class="fas fa-landmark"></i></div>
        </div>
        <div class="stat-value">{{ (cotisationsEstimees / 1000)|number_format(1) }}k€</div>
        <div class="stat-subtitle">{{ tauxCotisations }}% du CA</div>
    </div>
    {% endif %}

    <div class="stat-card info">
        <div class="stat-header">
            <span class="stat-label">Taux Conversion</span>
            <div class="stat-icon info"><i class="fas fa-percent"></i></div>
        </div>
        <div class="stat-value">{{ tauxConversion }}%</div>
        <div class="stat-subtitle">Devis → Factures</div>
    </div>

    <div class="stat-card {% if margeNetAnnee >= 30 %}success{% elseif margeNetAnnee >= 15 %}warning{% else %}danger{% endif %}">
        <div class="stat-header">
            <span class="stat-label">Bénéfice Net {{ year }}</span>
            <div class="stat-icon {% if margeNetAnnee >= 30 %}success{% elseif margeNetAnnee >= 15 %}warning{% else %}danger{% endif %}">
                <i class="fas fa-chart-line"></i>
            </div>
        </div>
        <div class="stat-value">{{ (beneficeNetAnnee / 1000)|number_format(1) }}k€</div>
        <div class="stat-subtitle">Après cotisations URSSAF : {{ margeNetAnnee }}%</div>
    </div>
</div>

<!-- Alertes -->
{% if nbFacturesEnRetard > 0 or nbDevisARelancer > 0 %}
<div style="margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
    {% if nbFacturesEnRetard > 0 %}
        <div class="alert-badge danger">
            <i class="fas fa-exclamation-circle"></i>
            {{ nbFacturesEnRetard }} facture(s) en retard ({{ (montantEnRetard / 1000)|number_format(1) }}k€)
        </div>
    {% endif %}
    {% if nbDevisARelancer > 0 %}
        <div class="alert-badge warning">
            <i class="fas fa-bell"></i>
            {{ nbDevisARelancer }} devis à relancer
        </div>
    {% endif %}
</div>
{% endif %}

<!-- Prévisions -->
{% if projections is not empty %}
<div class="chart-container" style="padding: 1rem 1.5rem;">
    <div class="chart-title" style="margin-bottom: 0.5rem;">
        <i class="fas fa-crystal-ball" style="color: var(--purple);"></i>
        Prévisions CA (moyenne 3 derniers mois)
    </div>
    <div style="display: flex; gap: 1.5rem; align-items: center; flex-wrap: wrap;">
        {% for proj in projections %}
            <div style="flex: 1; min-width: 150px;">
                <div style="font-size: 0.875rem; color: #6b7280; font-weight: 600;">{{ proj.month }}</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #3b82f6;">{{ (proj.amount / 1000)|number_format(1) }}k€</div>
            </div>
        {% endfor %}
        {% if tendance != 0 %}
            <div style="flex: 1; min-width: 150px; padding: 0.75rem; background: {% if tendance > 0 %}#f0fdf4{% else %}#fef2f2{% endif %}; border-radius: 8px;">
                <div style="font-size: 0.875rem; color: #6b7280; font-weight: 600;">Tendance</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: {% if tendance > 0 %}#10b981{% else %}#ef4444{% endif %};">
                    <i class="fas fa-arrow-{% if tendance > 0 %}up{% else %}down{% endif %}"></i> {{ tendance|abs }}%
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Graphiques -->
<div class="grid-2">
    <!-- Évolution CA Mensuel -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-chart-area" style="color: var(--primary);"></i>
            Évolution CA - {{ periodLabel }}
        </div>
        <canvas id="chartCAMensuel" class="chart-canvas"></canvas>
    </div>

    <!-- Top Clients -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-chart-pie" style="color: var(--success);"></i>
            Top 5 Clients - {{ periodLabel }}
        </div>
        <canvas id="chartClients" class="chart-canvas"></canvas>
    </div>
</div>

<!-- CA, Cotisations et Bénéfice -->
<div class="chart-container">
    <div class="chart-title">
        <i class="fas fa-chart-bar" style="color: var(--info);"></i>
        CA, Cotisations URSSAF et Bénéfice Net - {{ periodLabel }}
    </div>
    <canvas id="chartComparaison" class="chart-canvas"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Toggle custom date fields
function handlePeriodChange() {
    const select = document.getElementById('periodSelect');
    const customFields = document.getElementById('customDateFields');
    if (select.value === 'custom') {
        customFields.style.display = 'flex';
    } else {
        customFields.style.display = 'none';
    }
}

// Configuration commune
Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
Chart.defaults.plugins.legend.display = true;
Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(17, 24, 39, 0.95)';
Chart.defaults.plugins.tooltip.padding = 12;
Chart.defaults.plugins.tooltip.cornerRadius = 8;

// Données PHP → JS
const caParMois = {{ caParMois|json_encode|raw }};
const caParMoisComparison = {{ caParMoisComparison|json_encode|raw }};
const cotisationsParMois = {{ cotisationsParMois|json_encode|raw }};
const topClients = {{ topClients|json_encode|raw }};
const monthLabels = {{ monthLabels|json_encode|raw }};

// SEO Chart Data
const seoChartLabels = {{ seoChartData.labels|json_encode|raw }};
const seoChartClicks = {{ seoChartData.clicks|json_encode|raw }};
const seoChartImpressions = {{ seoChartData.impressions|json_encode|raw }};
const seoHasEnoughData = {{ seoChartData.hasEnoughData ? 'true' : 'false' }};

// 0. Graphique SEO Évolution (Clics/Impressions)
if (seoHasEnoughData && document.getElementById('chartSeoEvolution')) {
    new Chart(document.getElementById('chartSeoEvolution'), {
        type: 'line',
        data: {
            labels: seoChartLabels,
            datasets: [
                {
                    label: 'Clics',
                    data: seoChartClicks,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    yAxisID: 'y'
                },
                {
                    label: 'Impressions',
                    data: seoChartImpressions,
                    borderColor: '#06b6d4',
                    backgroundColor: 'rgba(6, 182, 212, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: { usePointStyle: true, padding: 15 }
                },
                tooltip: {
                    callbacks: {
                        title: (items) => {
                            if (items.length > 0) {
                                return 'Date: ' + items[0].label;
                            }
                            return '';
                        },
                        label: (ctx) => {
                            const value = ctx.parsed.y.toLocaleString('fr-FR');
                            return ctx.dataset.label + ': ' + value;
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Clics',
                        color: '#3b82f6'
                    },
                    ticks: {
                        color: '#3b82f6'
                    },
                    grid: { color: 'rgba(0,0,0,0.05)' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Impressions',
                        color: '#06b6d4'
                    },
                    ticks: {
                        color: '#06b6d4'
                    },
                    grid: { drawOnChartArea: false }
                },
                x: {
                    grid: { display: false },
                    ticks: {
                        maxTicksLimit: 10
                    }
                }
            }
        }
    });
}

// 1. Graphique Évolution CA Mensuel (Ligne) avec comparaison N-1
const hasComparisonData = caParMoisComparison.some(v => v > 0);

new Chart(document.getElementById('chartCAMensuel'), {
    type: 'line',
    data: {
        labels: monthLabels,
        datasets: [
            {
                label: 'CA Encaissé',
                data: caParMois,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 4,
                pointHoverRadius: 6
            },
            ...(hasComparisonData ? [{
                label: 'N-1',
                data: caParMoisComparison,
                borderColor: '#9ca3af',
                backgroundColor: 'transparent',
                borderDash: [5, 5],
                fill: false,
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 2,
                pointHoverRadius: 4
            }] : [])
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: hasComparisonData },
            tooltip: {
                callbacks: {
                    label: (ctx) => ctx.dataset.label + ': ' + ctx.parsed.y.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: (value) => (value / 1000) + 'k€'
                },
                grid: { color: 'rgba(0,0,0,0.05)' }
            },
            x: {
                grid: { display: false }
            }
        }
    }
});

// 2. Graphique Top Clients (Camembert)
const clientColors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
new Chart(document.getElementById('chartClients'), {
    type: 'doughnut',
    data: {
        labels: topClients.map(c => c.clientName),
        datasets: [{
            data: topClients.map(c => parseFloat(c.total)),
            backgroundColor: clientColors,
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: { padding: 15, font: { size: 11 } }
            },
            tooltip: {
                callbacks: {
                    label: (ctx) => {
                        const total = topClients.reduce((sum, c) => sum + parseFloat(c.total), 0);
                        const percent = Math.round((ctx.parsed / total) * 100);
                        return ctx.label + ': ' + ctx.parsed.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' }) + ' (' + percent + '%)';
                    }
                }
            }
        }
    }
});

// 3. Graphique CA vs Cotisations (Barres)
new Chart(document.getElementById('chartComparaison'), {
    type: 'bar',
    data: {
        labels: monthLabels,
        datasets: [
            {
                label: 'CA Encaissé',
                data: caParMois,
                backgroundColor: 'rgba(16, 185, 129, 0.7)',
                borderColor: '#10b981',
                borderWidth: 1
            },
            {
                label: 'Cotisations URSSAF',
                data: cotisationsParMois,
                backgroundColor: 'rgba(245, 158, 11, 0.7)',
                borderColor: '#f59e0b',
                borderWidth: 1
            },
            {
                label: 'Bénéfice Net',
                data: caParMois.map((ca, index) => {
                    const cotisations = cotisationsParMois[index] || 0;
                    return ca - cotisations;
                }),
                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                borderColor: '#3b82f6',
                borderWidth: 1
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
                labels: { padding: 15, usePointStyle: true }
            },
            tooltip: {
                callbacks: {
                    label: (ctx) => ctx.dataset.label + ': ' + ctx.parsed.y.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: (value) => (value / 1000) + 'k€'
                },
                grid: { color: 'rgba(0,0,0,0.05)' }
            },
            x: {
                grid: { display: false }
            }
        }
    }
});
</script>
{% endblock %}
