{% extends '@EasyAdmin/page/content.html.twig' %}

{% block content_title %}
    <i class="fa fa-chart-line"></i> Dashboard SEO
{% endblock %}

{% block page_content %}
{% include 'admin/dashboard/_partials/_styles.html.twig' %}
{% include 'admin/dashboard/_partials/_nav_tabs.html.twig' with {active: 'seo'} %}

<!-- Google Search Console Status -->
<div class="stat-card {% if googleOAuthConnected %}success{% elseif googleOAuthConfigured %}info{% else %}warning{% endif %}" style="margin-bottom: 1.5rem;">
    <div class="stat-header">
        <span class="stat-label">Google Search Console</span>
        <div class="stat-icon {% if googleOAuthConnected %}success{% elseif googleOAuthConfigured %}info{% else %}warning{% endif %}">
            <i class="fab fa-google"></i>
        </div>
    </div>
    {% if not googleOAuthConfigured %}
        <div style="color: #92400e; font-size: 0.875rem;">
            <i class="fas fa-exclamation-triangle"></i>
            Credentials non configures. Ajoutez <code>GOOGLE_CLIENT_ID</code> et <code>GOOGLE_CLIENT_SECRET</code> dans le fichier <code>.env.local</code>
        </div>
    {% elseif googleOAuthConnected %}
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <span style="color: #065f46; font-weight: 600;">
                    <i class="fas fa-check-circle"></i> Connecte
                </span>
                {% if googleOAuthToken %}
                    <div style="font-size: 0.75rem; margin-top: 0.25rem;">
                        {% if googleOAuthToken.isExpiringSoon(5) %}
                            <span style="color: #f59e0b;">
                                <i class="fas fa-exclamation-triangle"></i>
                                Token expire bientot (sera rafraichi automatiquement)
                            </span>
                        {% elseif googleOAuthToken.isExpired %}
                            <span style="color: #ef4444;">
                                <i class="fas fa-times-circle"></i>
                                Token expire - sera rafraichi au prochain appel API
                            </span>
                        {% else %}
                            <span style="color: #6b7280;">
                                Expire le {{ googleOAuthToken.expiresAt|date('d/m/Y à H:i') }}
                            </span>
                        {% endif %}
                    </div>
                {% endif %}
                {% if lastSeoSyncAt %}
                    <div style="font-size: 0.75rem; margin-top: 0.25rem; color: #6b7280;">
                        <i class="fas fa-sync-alt"></i> Derniere sync SEO: {{ lastSeoSyncAt|date('d/m/Y à H:i') }}
                    </div>
                {% endif %}
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <a href="{{ path('admin_google_sync_seo') }}" class="btn btn-sm btn-primary" title="Synchroniser les positions SEO">
                    <i class="fas fa-sync-alt"></i> Sync SEO
                </a>
                <a href="{{ path('admin_google_disconnect') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-unlink"></i> Deconnecter
                </a>
            </div>
        </div>
    {% else %}
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #6b7280;">Non connecte</div>
            <a href="{{ path('admin_google_connect') }}" class="btn btn-sm btn-primary">
                <i class="fab fa-google"></i> Connecter Google Search Console
            </a>
        </div>
    {% endif %}
</div>

<!-- Google Reviews Widget -->
<div class="stat-card {% if googlePlacesConfigured %}{% if reviewStats.total > 0 %}success{% else %}info{% endif %}{% else %}warning{% endif %}" style="margin-bottom: 1.5rem;">
    <div class="stat-header">
        <span class="stat-label">Avis Google</span>
        <div class="stat-icon {% if googlePlacesConfigured %}{% if reviewStats.total > 0 %}success{% else %}info{% endif %}{% else %}warning{% endif %}">
            <i class="fas fa-star"></i>
        </div>
    </div>
    {% if not googlePlacesConfigured %}
        <div style="color: #92400e; font-size: 0.875rem;">
            <i class="fas fa-exclamation-triangle"></i>
            API non configuree. Ajoutez <code>GOOGLE_PLACES_API_KEY</code> et <code>GOOGLE_PLACE_ID</code> dans le fichier <code>.env.local</code>
        </div>
    {% elseif reviewStats.total > 0 %}
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div style="display: flex; gap: 2rem; align-items: center; flex-wrap: wrap;">
                <!-- Note moyenne -->
                <div>
                    <div style="font-size: 2rem; font-weight: 700; color: #f59e0b; display: flex; align-items: center; gap: 0.5rem;">
                        {{ reviewStats.averageRating|number_format(1, ',', ' ') }}
                        <i class="fas fa-star" style="font-size: 1.5rem;"></i>
                    </div>
                    <div style="font-size: 0.75rem; color: #6b7280;">Note moyenne</div>
                </div>
                <!-- Compteurs -->
                <div style="display: flex; gap: 1.5rem;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.25rem; font-weight: 700; color: #10b981;">{{ reviewStats.approved }}</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">Approuves</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.25rem; font-weight: 700; color: #f59e0b;">{{ reviewStats.pending }}</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">En attente</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.25rem; font-weight: 700; color: #6b7280;">{{ reviewStats.total }}</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">Total</div>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                {% if not reviewsDataFresh %}
                    <span style="font-size: 0.75rem; color: #6b7280;">
                        <i class="fas fa-clock"></i> Donnees &gt; 12h
                    </span>
                {% endif %}
                <a href="{{ path('admin_reviews_sync') }}" class="btn btn-sm btn-primary" title="Synchroniser les avis Google">
                    <i class="fas fa-sync-alt"></i> Sync Avis
                </a>
                <a href="{{ ea_url().setController('App\\Controller\\Admin\\GoogleReviewCrudController').setAction('index') }}" class="btn btn-sm btn-outline-secondary" title="Gerer les avis">
                    <i class="fas fa-cog"></i>
                </a>
            </div>
        </div>
        {% if reviewsApiError %}
            <div style="margin-top: 1rem; padding: 0.75rem; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; color: #991b1b; font-size: 0.875rem;">
                <i class="fas fa-exclamation-circle"></i>
                <strong>Derniere erreur API :</strong> {{ reviewsApiError }}
            </div>
        {% endif %}
        {% if pendingReviews|length > 0 %}
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                <div style="font-size: 0.875rem; font-weight: 600; color: #92400e; margin-bottom: 0.5rem;">
                    <i class="fas fa-bell"></i> {{ pendingReviews|length }} avis en attente de moderation
                </div>
                {% for review in pendingReviews|slice(0, 3) %}
                    <div style="background: #fffbeb; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <div style="font-weight: 500;">{{ review.authorName }}</div>
                                <div style="color: #f59e0b;">
                                    {% for i in 1..5 %}
                                        <i class="fas fa-star{% if i > review.rating %}-o{% endif %}" style="font-size: 0.75rem;"></i>
                                    {% endfor %}
                                </div>
                            </div>
                            <div style="font-size: 0.75rem; color: #6b7280;">{{ review.reviewDate|date('d/m/Y') }}</div>
                        </div>
                        {% if review.comment %}
                            <div style="font-size: 0.875rem; color: #4b5563; margin-top: 0.5rem; font-style: italic;">
                                "{{ review.commentExcerpt(100) }}"
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% else %}
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #6b7280;">Aucun avis synchronise</div>
            <a href="{{ path('admin_reviews_sync') }}" class="btn btn-sm btn-primary">
                <i class="fas fa-sync-alt"></i> Synchroniser les avis
            </a>
        </div>
        {% if reviewsApiError %}
            <div style="margin-top: 1rem; padding: 0.75rem; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; color: #991b1b; font-size: 0.875rem;">
                <i class="fas fa-exclamation-circle"></i>
                <strong>Erreur API :</strong> {{ reviewsApiError }}
            </div>
        {% endif %}
    {% endif %}
</div>

<!-- SEO Positions Widget - Top 10 -->
{% if googleOAuthConnected and seoKeywordsRanked.top10|length > 0 %}
<div class="chart-container" style="padding: 1rem 1.5rem; margin-bottom: 1.5rem;">
    <div class="chart-title" style="margin-bottom: 1rem;">
        <i class="fas fa-trophy" style="color: #10b981;"></i>
        Top 10 - Meilleures performances
        <span style="font-size: 0.75rem; font-weight: 400; color: #6b7280; margin-left: 0.5rem;">
            (par score de visibilite)
        </span>
    </div>
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
            <thead>
                <tr style="border-bottom: 2px solid #10b981;">
                    <th style="text-align: left; padding: 0.75rem 0.5rem; color: #065f46; font-weight: 600;">Mot-cle</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #065f46; font-weight: 600;">Position</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #065f46; font-weight: 600;">Tend. 7j</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #065f46; font-weight: 600;">vs M-1</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #065f46; font-weight: 600;">Clics</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #065f46; font-weight: 600;">Impressions</th>
                </tr>
            </thead>
            <tbody>
                {% for keyword in seoKeywordsRanked.top10 %}
                    {% set latestPosition = keyword.latestPosition %}
                    {% set comparison = seoPositionComparisons[keyword.id] ?? null %}
                    {% set mom = seoMomentum[keyword.id] ?? null %}
                    <tr style="border-bottom: 1px solid #d1fae5;">
                        <td style="padding: 0.75rem 0.5rem; font-weight: 500;">
                            {{ keyword.keyword }}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% if latestPosition %}
                                {% set pos = latestPosition.position %}
                                {% if pos <= 10 %}
                                    <span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">
                                        {{ pos|number_format(1) }}
                                    </span>
                                {% elseif pos <= 20 %}
                                    <span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">
                                        {{ pos|number_format(1) }}
                                    </span>
                                {% else %}
                                    <span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">
                                        {{ pos|number_format(1) }}
                                    </span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% if mom %}
                                {% if mom.status == 'improved' %}
                                    <span style="color: #10b981; font-weight: 600;">
                                        <i class="fas fa-arrow-up"></i> +{{ mom.trend|abs|number_format(1) }}
                                    </span>
                                {% elseif mom.status == 'degraded' %}
                                    <span style="color: #ef4444; font-weight: 600;">
                                        <i class="fas fa-arrow-down"></i> {{ mom.trend|number_format(1) }}
                                    </span>
                                {% elseif mom.status == 'new' %}
                                    <span style="background: #dbeafe; color: #1d4ed8; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Nouveau</span>
                                {% else %}
                                    <span style="color: #6b7280;">=</span>
                                {% endif %}
                            {% else %}
                                <span style="color: #9ca3af;">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% if comparison %}
                                {% if comparison.status == 'improved' %}
                                    <span style="color: #10b981; font-weight: 600;">
                                        <i class="fas fa-arrow-up"></i> +{{ comparison.variation|abs|number_format(1) }}
                                    </span>
                                {% elseif comparison.status == 'degraded' %}
                                    <span style="color: #ef4444; font-weight: 600;">
                                        <i class="fas fa-arrow-down"></i> {{ comparison.variation|number_format(1) }}
                                    </span>
                                {% elseif comparison.status == 'stable' %}
                                    <span style="color: #6b7280;">=</span>
                                {% elseif comparison.status == 'new' %}
                                    <span style="background: #dbeafe; color: #1d4ed8; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Nouveau</span>
                                {% else %}
                                    <span style="color: #9ca3af;">-</span>
                                {% endif %}
                            {% else %}
                                <span style="color: #9ca3af;">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            <span style="font-weight: 700; color: #065f46;">{{ latestPosition.clicks }}</span>
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {{ latestPosition.impressions|number_format(0, '', ' ') }}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- SEO City Pages - Pages a optimiser -->
{% if googleOAuthConnected and seoCityPages|length > 0 %}
<div class="chart-container" style="padding: 1rem 1.5rem; margin-bottom: 1.5rem;">
    <div class="chart-title" style="margin-bottom: 1rem;">
        <i class="fas fa-map-marker-alt" style="color: #d97706;"></i>
        Pages a optimiser
        <span style="font-size: 0.75rem; font-weight: 400; color: #6b7280; margin-left: 0.5rem;">
            (agrege par ville)
        </span>
    </div>
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
            <thead>
                <tr style="border-bottom: 2px solid #d97706;">
                    <th style="text-align: left; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">Ville</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">A travailler</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">Total keywords</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">Position moy.</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">Score priorite</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;"></th>
                </tr>
            </thead>
            <tbody>
                {% for cityPage in seoCityPages %}
                    <tr style="border-bottom: 1px solid #fef3c7;" id="seo-city-row-{{ cityPage.city.id }}">
                        <td style="padding: 0.75rem 0.5rem; font-weight: 500;">
                            <i class="fas fa-map-pin" style="color: #d97706; font-size: 0.75rem; margin-right: 0.25rem;"></i>
                            {{ cityPage.city.name }}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            <span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">
                                {{ cityPage.toImproveCount }}
                            </span>
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {{ cityPage.totalCount }}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% if cityPage.avgPosition <= 10 %}
                                <span style="color: #065f46; font-weight: 600;">{{ cityPage.avgPosition }}</span>
                            {% elseif cityPage.avgPosition <= 20 %}
                                <span style="color: #92400e; font-weight: 600;">{{ cityPage.avgPosition }}</span>
                            {% else %}
                                <span style="color: #991b1b; font-weight: 600;">{{ cityPage.avgPosition }}</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            <span style="background: #fffbeb; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 700; font-size: 0.8rem;">
                                {{ cityPage.priorityScore }}
                            </span>
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            <button type="button"
                                class="btn btn-sm btn-outline-warning seo-city-mark-done"
                                data-city-id="{{ cityPage.city.id }}"
                                data-url="{{ path('admin_city_mark_optimized', {id: cityPage.city.id}) }}"
                                data-token="{{ csrf_token('city-optimize-' ~ cityPage.city.id) }}"
                                title="Marquer {{ cityPage.city.name }} comme optimise"
                                style="font-size: 0.75rem; padding: 0.15rem 0.5rem;">
                                <i class="fas fa-check"></i> Optimiser
                            </button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- SEO Positions Widget - A travailler -->
{% if googleOAuthConnected and seoKeywordsRanked.toImprove|length > 0 %}
<div class="chart-container" style="padding: 1rem 1.5rem; margin-bottom: 1.5rem;">
    <div class="chart-title" style="margin-bottom: 1rem;">
        <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
        A travailler
        <span style="font-size: 0.75rem; font-weight: 400; color: #6b7280; margin-left: 0.5rem;">
            (potentiel de clics inexploite)
        </span>
    </div>
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
            <thead>
                <tr style="border-bottom: 2px solid #f59e0b;">
                    <th style="text-align: left; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">Mot-cle</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">Position</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">Tend. 7j</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">vs M-1</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">Clics</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">Impr.</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;">Raison</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #92400e; font-weight: 600;"></th>
                </tr>
            </thead>
            <tbody>
                {% for item in seoKeywordsRanked.toImprove %}
                    {% set keyword = item.keyword %}
                    {% set latestPosition = keyword.latestPosition %}
                    {% set comparison = seoPositionComparisons[keyword.id] ?? null %}
                    {% set mom = seoMomentum[keyword.id] ?? null %}
                    <tr style="border-bottom: 1px solid #fef3c7;" id="seo-improve-row-{{ keyword.id }}">
                        <td style="padding: 0.75rem 0.5rem; font-weight: 500;">
                            {{ keyword.keyword }}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% if latestPosition %}
                                {% set pos = latestPosition.position %}
                                {% if pos <= 10 %}
                                    <span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">
                                        {{ pos|number_format(1) }}
                                    </span>
                                {% elseif pos <= 20 %}
                                    <span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">
                                        {{ pos|number_format(1) }}
                                    </span>
                                {% else %}
                                    <span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700;">
                                        {{ pos|number_format(1) }}
                                    </span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% if mom %}
                                {% if mom.status == 'improved' %}
                                    <span style="color: #10b981; font-weight: 600;">
                                        <i class="fas fa-arrow-up"></i> +{{ mom.trend|abs|number_format(1) }}
                                    </span>
                                {% elseif mom.status == 'degraded' %}
                                    <span style="color: #ef4444; font-weight: 600;">
                                        <i class="fas fa-arrow-down"></i> {{ mom.trend|number_format(1) }}
                                    </span>
                                {% elseif mom.status == 'new' %}
                                    <span style="background: #dbeafe; color: #1d4ed8; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Nouveau</span>
                                {% else %}
                                    <span style="color: #6b7280;">=</span>
                                {% endif %}
                            {% else %}
                                <span style="color: #9ca3af;">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% if comparison %}
                                {% if comparison.status == 'improved' %}
                                    <span style="color: #10b981; font-weight: 600;">
                                        <i class="fas fa-arrow-up"></i> +{{ comparison.variation|abs|number_format(1) }}
                                    </span>
                                {% elseif comparison.status == 'degraded' %}
                                    <span style="color: #ef4444; font-weight: 600;">
                                        <i class="fas fa-arrow-down"></i> {{ comparison.variation|number_format(1) }}
                                    </span>
                                {% elseif comparison.status == 'stable' %}
                                    <span style="color: #6b7280;">=</span>
                                {% elseif comparison.status == 'new' %}
                                    <span style="background: #dbeafe; color: #1d4ed8; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Nouveau</span>
                                {% else %}
                                    <span style="color: #9ca3af;">-</span>
                                {% endif %}
                            {% else %}
                                <span style="color: #9ca3af;">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            <span style="font-weight: 600; color: #92400e;">{{ latestPosition.clicks }}</span>
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {{ latestPosition.impressions|number_format(0, '', ' ') }}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            <span title="{{ item.action }}" style="cursor: help; color: #92400e; font-size: 0.8rem; white-space: nowrap;">
                                {{ item.reason }} <i class="fas fa-info-circle" style="color: #d97706; font-size: 0.7rem;"></i>
                            </span>
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            <button type="button"
                                class="btn btn-sm btn-outline-success seo-mark-done"
                                data-keyword-id="{{ keyword.id }}"
                                data-url="{{ path('admin_seo_keyword_mark_optimized', {id: keyword.id}) }}"
                                data-token="{{ csrf_token('seo-optimize-' ~ keyword.id) }}"
                                title="Marquer comme optimise aujourd'hui"
                                style="font-size: 0.75rem; padding: 0.15rem 0.5rem;">
                                <i class="fas fa-check"></i> Fait
                            </button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- SEO Actions -->
{% if googleOAuthConnected and (seoKeywordsRanked.top10|length > 0 or seoKeywordsRanked.toImprove|length > 0) %}
<div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
    <a href="{{ ea_url().setController('App\\Controller\\Admin\\SeoKeywordCrudController').setAction('index') }}" class="btn btn-sm btn-outline-secondary">
        <i class="fas fa-cog"></i> Gerer les mots-cles
    </a>
    <div style="display: flex; gap: 0.5rem;">
        <a href="{{ path('admin_seo_export_csv') }}" class="btn btn-sm btn-success">
            <i class="fas fa-file-csv"></i> Exporter SEO
        </a>
        <a href="{{ path('admin_google_sync_seo') }}" class="btn btn-sm btn-primary">
            <i class="fas fa-sync-alt"></i> Synchroniser
        </a>
    </div>
</div>
{% elseif googleOAuthConnected %}
<div class="stat-card info" style="margin-bottom: 1.5rem;">
    <div class="stat-header">
        <span class="stat-label">Positions SEO</span>
        <div class="stat-icon info"><i class="fas fa-search"></i></div>
    </div>
    <div style="color: #6b7280; font-size: 0.875rem;">
        Aucun mot-cle configure.
        <a href="{{ ea_url().setController('App\\Controller\\Admin\\SeoKeywordCrudController').setAction('new') }}" style="color: var(--primary); text-decoration: underline;">
            Ajouter des mots-cles
        </a>
        pour commencer le suivi SEO.
    </div>
</div>
{% endif %}

<!-- SEO Evolution Chart (Clics/Impressions) -->
{% if googleOAuthConnected and (seoKeywordsRanked.top10|length > 0 or seoKeywordsRanked.toImprove|length > 0) %}
<div class="chart-container" style="margin-bottom: 1.5rem;">
    <div class="chart-title">
        <i class="fas fa-chart-line" style="color: var(--info);"></i>
        Evolution SEO - 30 derniers jours
    </div>
    {% if seoChartData.hasEnoughData %}
        <canvas id="chartSeoEvolution" class="chart-canvas"></canvas>
    {% else %}
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; color: #6b7280;">
            <i class="fas fa-chart-line" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
            <div style="font-size: 0.875rem; text-align: center;">
                Donnees insuffisantes pour afficher les tendances<br>
                <span style="font-size: 0.75rem; opacity: 0.7;">({{ seoChartData.daysWithData }} jour{% if seoChartData.daysWithData > 1 %}s{% endif %} de donnees, minimum 7 requis)</span>
            </div>
        </div>
    {% endif %}
</div>

<!-- SEO 7-Day Rolling Chart -->
<div class="chart-container" style="margin-bottom: 1.5rem;">
    <div class="chart-title">
        <i class="fas fa-chart-area" style="color: var(--primary);"></i>
        Tendances SEO - Moyenne glissante 7 jours
    </div>
    {% if seoChartData.hasEnoughData %}
        <canvas id="chartSeo7d" class="chart-canvas"></canvas>
    {% else %}
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; color: #6b7280;">
            <i class="fas fa-chart-area" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
            <div style="font-size: 0.875rem;">Donnees insuffisantes</div>
        </div>
    {% endif %}
</div>

<!-- SEO Keywords Evolution Chart -->
<div class="chart-container" style="margin-bottom: 1.5rem;">
    <div class="chart-title" style="justify-content: space-between; flex-wrap: wrap;">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-key" style="color: var(--purple);"></i>
            Evolution des mots-cles SEO
            <span style="font-size: 0.75rem; font-weight: 400; color: #6b7280;">({{ seoKeywordsChartData.currentTotal }} actifs)</span>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">
                Haute: {{ seoKeywordsChartData.relevanceCounts.high }}
            </span>
            <span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">
                Moyenne: {{ seoKeywordsChartData.relevanceCounts.medium }}
            </span>
            <span style="background: #f3f4f6; color: #6b7280; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">
                Basse: {{ seoKeywordsChartData.relevanceCounts.low }}
            </span>
            {% if seoKeywordsChartData.inactiveCount > 0 %}
            <span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">
                Desactives: {{ seoKeywordsChartData.inactiveCount }}
            </span>
            {% endif %}
        </div>
    </div>
    {% if seoKeywordsChartData.currentTotal > 0 %}
        <canvas id="chartSeoKeywords" class="chart-canvas"></canvas>
    {% else %}
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; color: #6b7280;">
            <i class="fas fa-key" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
            <div style="font-size: 0.875rem;">Aucun mot-cle actif</div>
        </div>
    {% endif %}
</div>

<!-- SEO Performance Categories -->
<div class="grid-2" style="margin-bottom: 1.5rem;">
    <!-- Top Performers -->
    <div class="chart-container" style="height: auto; padding: 1.25rem;">
        <div class="chart-title" style="margin-bottom: 1rem;">
            <i class="fas fa-trophy" style="color: var(--success);"></i>
            Top Performers
            <span style="font-size: 0.75rem; font-weight: 400; color: #6b7280; margin-left: 0.5rem;">(visibilite x position x clics)</span>
        </div>
        {% if seoPerformanceData.topPerformers|length > 0 %}
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                {% for item in seoPerformanceData.topPerformers %}
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f0fdf4; border-radius: 8px;">
                        <div style="font-weight: 500; font-size: 0.875rem;">{{ item.keyword }}</div>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="background: #d1fae5; color: #065f46; padding: 0.125rem 0.5rem; border-radius: 9999px; font-weight: 700; font-size: 0.75rem;">
                                #{{ item.position|number_format(0) }}
                            </span>
                            {% if item.clicks > 0 %}
                                <span style="color: #065f46; font-size: 0.75rem; font-weight: 600;">{{ item.clicks }} clic{{ item.clicks > 1 ? 's' : '' }}</span>
                            {% else %}
                                <span style="color: #6b7280; font-size: 0.75rem;">{{ item.impressions }} imp.</span>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; color: #6b7280;">
                <i class="fas fa-trophy" style="font-size: 2rem; opacity: 0.3; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 0.875rem; text-align: center;">Aucun mot-cle en premiere page encore</div>
            </div>
        {% endif %}
    </div>

    <!-- A travailler -->
    <div class="chart-container" style="height: auto; padding: 1.25rem;">
        <div class="chart-title" style="margin-bottom: 1rem;">
            <i class="fas fa-wrench" style="color: #f59e0b;"></i>
            A travailler
            <span style="font-size: 0.75rem; font-weight: 400; color: #6b7280; margin-left: 0.5rem;">(prochain potentiel par score)</span>
        </div>
        {% if seoPerformanceData.toImprove|length > 0 %}
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                {% for item in seoPerformanceData.toImprove %}
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #fffbeb; border-radius: 8px;">
                        <div style="font-weight: 500; font-size: 0.875rem;">{{ item.keyword }}</div>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="background: #fef3c7; color: #92400e; padding: 0.125rem 0.5rem; border-radius: 9999px; font-weight: 700; font-size: 0.75rem;">
                                #{{ item.position|number_format(0) }}
                            </span>
                            {% if item.clicks > 0 %}
                                <span style="color: #92400e; font-size: 0.75rem; font-weight: 600;">{{ item.clicks }} clic{{ item.clicks > 1 ? 's' : '' }}</span>
                            {% else %}
                                <span style="color: #6b7280; font-size: 0.75rem;">{{ item.impressions }} imp.</span>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; color: #6b7280;">
                <i class="fas fa-check-circle" style="font-size: 2rem; opacity: 0.3; color: #10b981; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 0.875rem; text-align: center;">Pas assez de donnees pour identifier des mots-cles a travailler</div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Opportunites CTR -->
{% if seoPerformanceData.ctrOpportunities|length > 0 %}
<div class="chart-container" style="height: auto; padding: 1.25rem; margin-bottom: 1.5rem;">
    <div class="chart-title" style="margin-bottom: 1rem;">
        <i class="fas fa-lightbulb" style="color: var(--warning);"></i>
        Opportunites CTR
        <span style="font-size: 0.75rem; font-weight: 400; color: #6b7280; margin-left: 0.5rem;">(Beaucoup d'impressions, peu de clics)</span>
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 0.75rem;">
        {% for item in seoPerformanceData.ctrOpportunities %}
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #fffbeb; border-radius: 8px; border-left: 3px solid #f59e0b;">
                <div>
                    <div style="font-weight: 500; font-size: 0.875rem;">{{ item.keyword }}</div>
                    <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                        {{ item.impressions|number_format(0, '', ' ') }} impressions
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 700; font-size: 0.875rem;">
                        CTR {{ item.ctr }}%
                    </div>
                    <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                        {{ item.clicks }} clics
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
    <div style="margin-top: 0.75rem; font-size: 0.75rem; color: #6b7280;">
        <i class="fas fa-info-circle"></i> Ces mots-cles generent des impressions mais peu de clics. Ameliorez vos meta descriptions et titres pour augmenter le CTR.
    </div>
</div>
{% endif %}
{% endif %}

<!-- Chart.js Scripts -->
{% if googleOAuthConnected and (seoKeywordsRanked.top10|length > 0 or seoKeywordsRanked.toImprove|length > 0) %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Configuration commune
Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
Chart.defaults.plugins.legend.display = true;
Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(17, 24, 39, 0.95)';
Chart.defaults.plugins.tooltip.padding = 12;
Chart.defaults.plugins.tooltip.cornerRadius = 8;

// SEO Chart Data - Daily
const seoChartLabels = {{ seoChartData.labels|json_encode|raw }};
const seoChartClicks = {{ seoChartData.clicks|json_encode|raw }};
const seoChartImpressions = {{ seoChartData.impressions|json_encode|raw }};
const seoChartCtr = {{ seoChartData.ctr|json_encode|raw }};
const seoChartPosition = {{ seoChartData.position|json_encode|raw }};
// SEO Chart Data - 7-day rolling
const seoChartClicks7d = {{ seoChartData.clicks7d|json_encode|raw }};
const seoChartImpressions7d = {{ seoChartData.impressions7d|json_encode|raw }};
const seoChartCtr7d = {{ seoChartData.ctr7d|json_encode|raw }};
const seoChartPosition7d = {{ seoChartData.position7d|json_encode|raw }};
const seoHasEnoughData = {{ seoChartData.hasEnoughData ? 'true' : 'false' }};

// SEO Keywords Chart Data
const seoKwLabels = {{ seoKeywordsChartData.labels|json_encode|raw }};
const seoKwTotalKeywords = {{ seoKeywordsChartData.totalKeywords|json_encode|raw }};
const seoKwNewHigh = {{ seoKeywordsChartData.newHigh|json_encode|raw }};
const seoKwNewMedium = {{ seoKeywordsChartData.newMedium|json_encode|raw }};
const seoKwNewLow = {{ seoKeywordsChartData.newLow|json_encode|raw }};
const seoKwDeactivated = {{ seoKeywordsChartData.deactivated|json_encode|raw }};

// Graphique SEO Evolution
if (seoHasEnoughData && document.getElementById('chartSeoEvolution')) {
    new Chart(document.getElementById('chartSeoEvolution'), {
        type: 'line',
        data: {
            labels: seoChartLabels,
            datasets: [
                {
                    label: 'Clics',
                    data: seoChartClicks,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 2,
                    pointHoverRadius: 5,
                    yAxisID: 'yClicks'
                },
                {
                    label: 'Impressions',
                    data: seoChartImpressions,
                    borderColor: '#06b6d4',
                    backgroundColor: 'rgba(6, 182, 212, 0.05)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 2,
                    pointHoverRadius: 5,
                    yAxisID: 'yImpressions'
                },
                {
                    label: 'CTR (%)',
                    data: seoChartCtr,
                    borderColor: '#8b5cf6',
                    backgroundColor: 'transparent',
                    fill: false,
                    tension: 0.4,
                    borderWidth: 2,
                    borderDash: [4, 4],
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    yAxisID: 'yCtr'
                },
                {
                    label: 'Position',
                    data: seoChartPosition,
                    borderColor: '#f59e0b',
                    backgroundColor: 'transparent',
                    fill: false,
                    tension: 0.4,
                    borderWidth: 2,
                    borderDash: [2, 2],
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    yAxisID: 'yPosition'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 12, font: { size: 11 } } },
                tooltip: {
                    callbacks: {
                        title: (items) => items.length > 0 ? 'Date: ' + items[0].label : '',
                        label: (ctx) => {
                            let value = ctx.parsed.y;
                            if (ctx.dataset.label === 'CTR (%)') return ctx.dataset.label + ': ' + value.toFixed(2) + '%';
                            if (ctx.dataset.label === 'Position') return ctx.dataset.label + ': ' + value.toFixed(1);
                            return ctx.dataset.label + ': ' + value.toLocaleString('fr-FR');
                        }
                    }
                }
            },
            scales: {
                yClicks: { type: 'linear', display: true, position: 'left', beginAtZero: true, title: { display: true, text: 'Clics', color: '#3b82f6', font: { size: 10 } }, ticks: { color: '#3b82f6', font: { size: 9 } }, grid: { color: 'rgba(0,0,0,0.05)' } },
                yImpressions: { type: 'linear', display: true, position: 'right', beginAtZero: true, title: { display: true, text: 'Impressions', color: '#06b6d4', font: { size: 10 } }, ticks: { color: '#06b6d4', font: { size: 9 } }, grid: { drawOnChartArea: false } },
                yCtr: { type: 'linear', display: false, beginAtZero: true, max: 10, grid: { drawOnChartArea: false } },
                yPosition: { type: 'linear', display: false, reverse: true, min: 1, max: 100, grid: { drawOnChartArea: false } },
                x: { grid: { display: false }, ticks: { maxTicksLimit: 10, font: { size: 10 } } }
            }
        }
    });
}

// Graphique SEO 7 jours glissants
if (seoHasEnoughData && document.getElementById('chartSeo7d')) {
    new Chart(document.getElementById('chartSeo7d'), {
        type: 'line',
        data: {
            labels: seoChartLabels,
            datasets: [
                {
                    label: 'Clics (cumul 7j)',
                    data: seoChartClicks7d,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true, tension: 0.4, borderWidth: 2, pointRadius: 2, pointHoverRadius: 5,
                    yAxisID: 'yClicks7d'
                },
                {
                    label: 'Impressions (cumul 7j)',
                    data: seoChartImpressions7d,
                    borderColor: '#06b6d4',
                    backgroundColor: 'rgba(6, 182, 212, 0.05)',
                    fill: true, tension: 0.4, borderWidth: 2, pointRadius: 2, pointHoverRadius: 5,
                    yAxisID: 'yImpressions7d'
                },
                {
                    label: 'CTR moy. 7j (%)',
                    data: seoChartCtr7d,
                    borderColor: '#8b5cf6',
                    backgroundColor: 'transparent',
                    fill: false, tension: 0.4, borderWidth: 2, borderDash: [4, 4], pointRadius: 0, pointHoverRadius: 4,
                    yAxisID: 'yCtr7d'
                },
                {
                    label: 'Position moy. 7j',
                    data: seoChartPosition7d,
                    borderColor: '#f59e0b',
                    backgroundColor: 'transparent',
                    fill: false, tension: 0.4, borderWidth: 2, borderDash: [2, 2], pointRadius: 0, pointHoverRadius: 4,
                    yAxisID: 'yPosition7d'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 12, font: { size: 11 } } },
                tooltip: {
                    callbacks: {
                        title: (items) => items.length > 0 ? 'Semaine se terminant le ' + items[0].label : '',
                        label: (ctx) => {
                            let value = ctx.parsed.y;
                            if (value === null) return null;
                            if (ctx.dataset.label.includes('CTR')) return ctx.dataset.label + ': ' + value.toFixed(2) + '%';
                            if (ctx.dataset.label.includes('Position')) return ctx.dataset.label + ': ' + value.toFixed(1);
                            return ctx.dataset.label + ': ' + value.toLocaleString('fr-FR');
                        }
                    }
                }
            },
            scales: {
                yClicks7d: { type: 'linear', display: true, position: 'left', beginAtZero: true, title: { display: true, text: 'Clics (7j)', color: '#3b82f6', font: { size: 10 } }, ticks: { color: '#3b82f6', font: { size: 9 } }, grid: { color: 'rgba(0,0,0,0.05)' } },
                yImpressions7d: { type: 'linear', display: true, position: 'right', beginAtZero: true, title: { display: true, text: 'Impressions (7j)', color: '#06b6d4', font: { size: 10 } }, ticks: { color: '#06b6d4', font: { size: 9 } }, grid: { drawOnChartArea: false } },
                yCtr7d: { type: 'linear', display: false, beginAtZero: true, max: 10, grid: { drawOnChartArea: false } },
                yPosition7d: { type: 'linear', display: false, reverse: true, min: 1, max: 100, grid: { drawOnChartArea: false } },
                x: { grid: { display: false }, ticks: { maxTicksLimit: 10, font: { size: 10 } } }
            }
        }
    });
}

// Graphique Evolution Mots-cles SEO
if (document.getElementById('chartSeoKeywords')) {
    new Chart(document.getElementById('chartSeoKeywords'), {
        type: 'bar',
        data: {
            labels: seoKwLabels,
            datasets: [
                { label: 'Nouveaux (haute)', data: seoKwNewHigh, backgroundColor: 'rgba(34, 197, 94, 0.8)', borderColor: '#22c55e', borderWidth: 1, stack: 'newKeywords', yAxisID: 'yNew', order: 2 },
                { label: 'Nouveaux (moyenne)', data: seoKwNewMedium, backgroundColor: 'rgba(245, 158, 11, 0.8)', borderColor: '#f59e0b', borderWidth: 1, stack: 'newKeywords', yAxisID: 'yNew', order: 2 },
                { label: 'Nouveaux (basse)', data: seoKwNewLow, backgroundColor: 'rgba(156, 163, 175, 0.8)', borderColor: '#9ca3af', borderWidth: 1, stack: 'newKeywords', yAxisID: 'yNew', order: 2 },
                { label: 'Desactives', data: seoKwDeactivated, backgroundColor: 'rgba(239, 68, 68, 0.8)', borderColor: '#ef4444', borderWidth: 1, stack: 'newKeywords', yAxisID: 'yNew', order: 2 },
                {
                    label: 'Total cumule',
                    data: seoKwTotalKeywords,
                    type: 'line',
                    borderColor: '#8b5cf6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    fill: true, tension: 0.4, borderWidth: 2, pointRadius: 2, pointHoverRadius: 5,
                    yAxisID: 'yTotal', order: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 12, font: { size: 11 } } },
                tooltip: {
                    callbacks: {
                        label: (ctx) => {
                            if (ctx.parsed.y === 0 && ctx.dataset.type !== 'line') return null;
                            if (ctx.dataset.label === 'Desactives') return ctx.dataset.label + ': ' + Math.abs(ctx.parsed.y);
                            return ctx.dataset.label + ': ' + ctx.parsed.y;
                        }
                    }
                }
            },
            scales: {
                yNew: { type: 'linear', display: true, position: 'left', beginAtZero: true, stacked: true, title: { display: true, text: 'Nouveaux / jour', color: '#22c55e', font: { size: 10 } }, ticks: { color: '#22c55e', font: { size: 9 }, stepSize: 1 }, grid: { color: 'rgba(0,0,0,0.05)' } },
                yTotal: { type: 'linear', display: true, position: 'right', beginAtZero: true, title: { display: true, text: 'Total mots-cles', color: '#8b5cf6', font: { size: 10 } }, ticks: { color: '#8b5cf6', font: { size: 9 } }, grid: { drawOnChartArea: false } },
                x: { stacked: true, grid: { display: false }, ticks: { maxTicksLimit: 10, font: { size: 10 } } }
            }
        }
    });
}
// Bouton "Optimiser" - marquer une ville comme optimisee
document.querySelectorAll('.seo-city-mark-done').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var url = this.dataset.url;
        var token = this.dataset.token;
        var cityId = this.dataset.cityId;
        var row = document.getElementById('seo-city-row-' + cityId);
        var button = this;

        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: '_token=' + encodeURIComponent(token)
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                row.style.transition = 'opacity 0.3s';
                row.style.opacity = '0';
                setTimeout(function() { row.remove(); }, 300);
            } else {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-check"></i> Optimiser';
            }
        })
        .catch(function() {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-check"></i> Optimiser';
        });
    });
});

// Bouton "Fait" - marquer un mot-clé comme optimisé
document.querySelectorAll('.seo-mark-done').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var url = this.dataset.url;
        var token = this.dataset.token;
        var keywordId = this.dataset.keywordId;
        var row = document.getElementById('seo-improve-row-' + keywordId);
        var button = this;

        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: '_token=' + encodeURIComponent(token)
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                row.style.transition = 'opacity 0.3s';
                row.style.opacity = '0';
                setTimeout(function() { row.remove(); }, 300);
            } else {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-check"></i> Fait';
            }
        })
        .catch(function() {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-check"></i> Fait';
        });
    });
});
</script>
{% endif %}
{% endblock %}
