{% extends '@EasyAdmin/crud/form_theme.html.twig' %}

{% block form_end %}
    {{ parent() }}
    <script>
    (function() {
        if (window.prospectContactFilterInitialized) return;
        window.prospectContactFilterInitialized = true;

        function initProspectContactFilter() {
            const prospectSelect = document.querySelector('[name$="[prospect]"]');
            const contactSelect = document.querySelector('[name$="[contact]"]');

            if (!prospectSelect || !contactSelect) return;

            function filterContacts(prospectId) {
                if (!prospectId) {
                    contactSelect.innerHTML = '<option value="">-- Sélectionner un contact --</option>';
                    return;
                }

                fetch('/saeiblauhjc/prospection/contacts/' + prospectId)
                    .then(response => response.json())
                    .then(contacts => {
                        const currentValue = contactSelect.value;
                        contactSelect.innerHTML = '<option value="">-- Sélectionner un contact --</option>';

                        contacts.forEach(contact => {
                            const option = document.createElement('option');
                            option.value = contact.id;
                            option.text = contact.name + (contact.email ? ' (' + contact.email + ')' : '');
                            if (contact.primary) {
                                option.text += ' - Principal';
                            }
                            contactSelect.appendChild(option);
                        });

                        if (currentValue) {
                            contactSelect.value = currentValue;
                        }
                    })
                    .catch(error => console.error('Error fetching contacts:', error));
            }

            prospectSelect.addEventListener('change', function() {
                filterContacts(this.value);
            });

            if (prospectSelect.value) {
                filterContacts(prospectSelect.value);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initProspectContactFilter);
        } else {
            initProspectContactFilter();
        }
    })();
    </script>
{% endblock %}
