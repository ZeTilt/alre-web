{% extends '@EasyAdmin/page/content.html.twig' %}

{% block content_title %}
    <i class="fa fa-history"></i> Historique des synchronisations SEO
{% endblock %}

{% block page_content %}
{% include 'admin/dashboard/_partials/_styles.html.twig' %}

<div style="margin-bottom: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
    <a href="{{ path('admin_seo_dashboard') }}" class="btn btn-sm btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> Dashboard SEO
    </a>
</div>

{% if logs|length == 0 %}
<div class="stat-card info" style="text-align: center; padding: 3rem;">
    <i class="fas fa-history" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem; display: block;"></i>
    <div style="font-size: 1.125rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Aucune synchronisation enregistree</div>
    <div style="color: #6b7280;">Les synchronisations cron (seo-sync, client-seo-auto-sync) apparaitront ici.</div>
</div>
{% else %}
<div class="chart-container" style="padding: 1rem 1.5rem;">
    <div class="chart-title" style="margin-bottom: 1rem;">
        <i class="fas fa-history" style="color: var(--purple, #8b5cf6);"></i>
        {{ logs|length }} derniere{{ logs|length > 1 ? 's' : '' }} synchronisation{{ logs|length > 1 ? 's' : '' }}
    </div>
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
            <thead>
                <tr style="border-bottom: 2px solid #e5e7eb;">
                    <th style="text-align: left; padding: 0.75rem 0.5rem; color: #374151; font-weight: 600;">Date</th>
                    <th style="text-align: left; padding: 0.75rem 0.5rem; color: #374151; font-weight: 600;">Commande</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #374151; font-weight: 600;">Duree</th>
                    <th style="text-align: center; padding: 0.75rem 0.5rem; color: #374151; font-weight: 600;">Statut</th>
                    <th style="text-align: left; padding: 0.75rem 0.5rem; color: #374151; font-weight: 600;">Resume</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                    <tr style="border-bottom: 1px solid #f3f4f6; cursor: pointer;" class="sync-log-row" data-log-id="{{ log.id }}">
                        <td style="padding: 0.75rem 0.5rem; white-space: nowrap;">
                            {{ log.startedAt|date('d/m/Y a H:i:s') }}
                        </td>
                        <td style="padding: 0.75rem 0.5rem;">
                            {% if log.command == 'seo-sync' %}
                                <span style="background: #eff6ff; color: #1d4ed8; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">
                                    <i class="fas fa-globe"></i> {{ log.commandLabel }}
                                </span>
                            {% else %}
                                <span style="background: #f5f3ff; color: #5b21b6; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">
                                    <i class="fas fa-users"></i> {{ log.commandLabel }}
                                </span>
                            {% endif %}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem; color: #6b7280; font-size: 0.8rem;">
                            {{ log.durationFormatted }}
                        </td>
                        <td style="text-align: center; padding: 0.75rem 0.5rem;">
                            {% if log.status == 'success' %}
                                <span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                                    <i class="fas fa-check"></i> Succes
                                </span>
                            {% elseif log.status == 'partial' %}
                                <span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                                    <i class="fas fa-exclamation-triangle"></i> Partiel
                                </span>
                            {% elseif log.status == 'error' %}
                                <span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                                    <i class="fas fa-times"></i> Erreur
                                </span>
                            {% else %}
                                <span style="background: #e5e7eb; color: #6b7280; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                                    {{ log.status }}
                                </span>
                            {% endif %}
                        </td>
                        <td style="padding: 0.75rem 0.5rem; font-size: 0.8rem; color: #6b7280;">
                            {% if log.details %}
                                {% if log.command == 'seo-sync' %}
                                    {% if log.details.gsc_positions is defined %}
                                        <span title="GSC positions"><i class="fab fa-google" style="color: #4285f4;"></i> {{ log.details.gsc_positions.synced ?? 0 }} pos.</span>
                                    {% endif %}
                                    {% if log.details.gsc_keywords is defined and log.details.gsc_keywords.imported > 0 %}
                                        <span style="margin-left: 0.5rem;" title="Nouveaux mots-cles"><i class="fas fa-plus" style="color: #10b981;"></i> {{ log.details.gsc_keywords.imported }} kw</span>
                                    {% endif %}
                                    {% if log.details.bing_keywords is defined %}
                                        <span style="margin-left: 0.5rem;" title="Bing keywords"><i class="fab fa-microsoft" style="color: #0078d4;"></i> {{ log.details.bing_keywords.synced ?? 0 }} kw</span>
                                    {% endif %}
                                    {% if log.details.reviews is defined and (log.details.reviews.created > 0 or log.details.reviews.updated > 0) %}
                                        <span style="margin-left: 0.5rem;" title="Avis Google"><i class="fas fa-star" style="color: #f59e0b;"></i> +{{ log.details.reviews.created }}/~{{ log.details.reviews.updated }}</span>
                                    {% endif %}
                                {% elseif log.command == 'client-seo-auto-sync' %}
                                    <span title="Sites traites"><i class="fas fa-globe"></i> {{ log.details.sites_processed ?? 0 }} site{{ (log.details.sites_processed ?? 0) > 1 ? 's' : '' }}</span>
                                    {% if log.details.gsc.positions is defined and log.details.gsc.positions > 0 %}
                                        <span style="margin-left: 0.5rem;" title="GSC positions"><i class="fab fa-google" style="color: #4285f4;"></i> {{ log.details.gsc.positions }} pos.</span>
                                    {% endif %}
                                    {% if log.details.bing.positions is defined and log.details.bing.positions > 0 %}
                                        <span style="margin-left: 0.5rem;" title="Bing positions"><i class="fab fa-microsoft" style="color: #0078d4;"></i> {{ log.details.bing.positions }} pos.</span>
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                <span style="color: #d1d5db;">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {# Error message row #}
                    {% if log.errorMessage %}
                        <tr class="sync-log-error" data-parent="{{ log.id }}">
                            <td colspan="5" style="padding: 0.5rem 0.75rem; background: #fef2f2; color: #991b1b; font-size: 0.8rem;">
                                <i class="fas fa-exclamation-circle"></i> {{ log.errorMessage }}
                            </td>
                        </tr>
                    {% endif %}
                    {# Expandable details row #}
                    {% if log.details %}
                        <tr class="sync-log-details" data-parent="{{ log.id }}" style="display: none;">
                            <td colspan="5" style="padding: 0.75rem; background: #f9fafb;">
                                <pre style="margin: 0; font-size: 0.75rem; color: #374151; white-space: pre-wrap; word-break: break-word; max-width: 100%; overflow-x: auto;">{{ log.details|json_encode(constant('JSON_PRETTY_PRINT') b-or constant('JSON_UNESCAPED_UNICODE')) }}</pre>
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.querySelectorAll('.sync-log-row').forEach(function(row) {
    row.addEventListener('click', function() {
        var logId = this.dataset.logId;
        var detailsRow = document.querySelector('.sync-log-details[data-parent="' + logId + '"]');
        if (detailsRow) {
            detailsRow.style.display = detailsRow.style.display === 'none' ? '' : 'none';
        }
    });
});
</script>
{% endif %}
{% endblock %}
