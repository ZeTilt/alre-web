{% extends '@!EasyAdmin/layout.html.twig' %}

{% block head_metas %}
    {{ parent() }}
    <link rel="manifest" href="{{ asset('admin-manifest.json') }}">
    <meta name="theme-color" content="#2B5F75">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Alré Admin">
    <link rel="apple-touch-icon" href="{{ asset('images/android-chrome-192x192.png') }}">
{% endblock %}

{% block head_stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/admin.css') }}">
    <style>
        /* Inline CSS to ensure it loads */
        .ea-sidebar .menu-item-icon,
        .ea-sidebar .menu-item-icon i,
        .ea-sidebar .menu-item-icon .fa,
        .ea-sidebar .menu-item-icon .fas,
        .ea-sidebar .menu-item-icon .far,
        .ea-sidebar .menu-item-icon .fab {
            font-size: 1rem !important;
            width: 1.25rem !important;
            height: 1.25rem !important;
            line-height: 1.25rem !important;
        }

        .btn .fa, .btn .fas, .btn .far, .btn .fab {
            font-size: 0.875rem !important;
        }

        .table .fa, .table .fas, .table .far, .table .fab {
            font-size: 0.875rem !important;
        }

        .ea-header-logo,
        .ea-header-logo a {
            color: #2B5F75 !important;
            font-weight: 600;
        }

        .btn-primary {
            background-color: #2B5F75;
            border-color: #2B5F75;
        }

        .btn-primary:hover,
        .btn-primary:focus,
        .btn-primary:active {
            background-color: #1e4659;
            border-color: #1e4659;
        }

        a {
            color: #2B5F75;
        }

        a:hover {
            color: #1e4659;
        }

        .form-control:focus {
            border-color: #2B5F75;
            box-shadow: 0 0 0 0.2rem rgba(43, 95, 117, 0.25);
        }

        .pagination .page-link {
            color: #2B5F75;
        }

        .pagination .page-item.active .page-link {
            background-color: #2B5F75;
            border-color: #2B5F75;
        }

        .table th {
            color: #2B5F75;
            font-weight: 600;
        }

        /* Additional icon fixes */
        .ea-sidebar .menu-item-name {
            margin-left: 0.5rem;
        }

        .ea-sidebar .menu-item-contents {
            display: flex;
            align-items: center;
        }

        /* Make sure icons don't overflow */
        .ea-sidebar .menu-item-icon {
            flex-shrink: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Status dropdown styling */
        .badge.dropdown-toggle {
            border: none;
            padding: 0.375rem 0.75rem;
        }

        .badge.dropdown-toggle:hover {
            opacity: 0.8;
        }

        .badge.dropdown-toggle::after {
            display: none;
        }
    </style>
{% endblock %}

{% block body_javascript %}
    {{ parent() }}
    <script>
        // Ensure Bootstrap dropdowns work properly
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize all dropdowns
            var dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'))
            var dropdownList = dropdownElementList.map(function (dropdownToggleEl) {
                return new bootstrap.Dropdown(dropdownToggleEl)
            })
        });

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/admin-sw.js', { scope: '/saeiblauhjc' })
                .then(reg => console.log('Admin SW registered'))
                .catch(err => console.log('Admin SW failed:', err));
        }

        // === PUSH NOTIFICATIONS MANAGER ===
        window.PushNotificationManager = {
            publicKey: null,
            registration: null,

            async init() {
                if (!('PushManager' in window)) {
                    console.log('Push non supporté');
                    return;
                }

                try {
                    const response = await fetch('/saeiblauhjc/push/vapid-public-key');
                    const data = await response.json();
                    this.publicKey = data.publicKey;

                    this.registration = await navigator.serviceWorker.ready;
                    await this.updateUI();
                } catch (err) {
                    console.error('Erreur init push:', err);
                }
            },

            async subscribe() {
                try {
                    const subscription = await this.registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: this.urlBase64ToUint8Array(this.publicKey)
                    });

                    await fetch('/saeiblauhjc/push/subscribe', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(subscription.toJSON())
                    });

                    await this.updateUI();
                    return true;
                } catch (err) {
                    console.error('Erreur abonnement:', err);
                    return false;
                }
            },

            async unsubscribe() {
                const subscription = await this.registration.pushManager.getSubscription();
                if (subscription) {
                    await subscription.unsubscribe();
                    await fetch('/saeiblauhjc/push/unsubscribe', { method: 'POST' });
                }
                await this.updateUI();
            },

            async isSubscribed() {
                if (!this.registration) return false;
                const subscription = await this.registration.pushManager.getSubscription();
                return !!subscription;
            },

            async updateUI() {
                const subscription = await this.registration.pushManager.getSubscription();
                const btn = document.getElementById('pushToggleBtn');
                const testBtn = document.getElementById('pushTestBtn');

                if (btn) {
                    if (subscription) {
                        btn.innerHTML = '<i class="fas fa-bell-slash"></i> Désactiver';
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-outline-secondary');
                    } else {
                        btn.innerHTML = '<i class="fas fa-bell"></i> Activer les notifications';
                        btn.classList.remove('btn-outline-secondary');
                        btn.classList.add('btn-primary');
                    }
                    btn.dataset.subscribed = subscription ? 'true' : 'false';
                }

                if (testBtn) {
                    testBtn.style.display = subscription ? 'block' : 'none';
                }
            },

            async test() {
                const response = await fetch('/saeiblauhjc/push/test', { method: 'POST' });
                const data = await response.json();
                if (!data.success) {
                    alert('Erreur lors de l\'envoi de la notification test');
                }
            },

            urlBase64ToUint8Array(base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
                const rawData = window.atob(base64);
                return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
            }
        };

        // Fonction globale pour toggle
        window.togglePushSubscription = async function() {
            const isSubscribed = await PushNotificationManager.isSubscribed();
            if (isSubscribed) {
                await PushNotificationManager.unsubscribe();
            } else {
                await PushNotificationManager.subscribe();
            }
        };

        window.testPushNotification = async function() {
            await PushNotificationManager.test();
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            if ('PushManager' in window) {
                PushNotificationManager.init();
            }
        });
    </script>
{% endblock %}