<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devis {{ devis.number }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        body {
            font-family: "Helvetica", Arial, sans-serif;
            font-size: 10px;
            color: #333333;
            line-height: 1.5;
            padding: 20px;
            margin-right: 10px;
        }

        /* En-t√™te */
        .header-wrapper { margin-bottom: 15px; border-bottom: 2px solid #27A3B4; padding-bottom: 10px; display: flex; justify-content: space-between; }
        .logo-cell { width: 30%; }
        .logo { max-width: 140px; height: auto; }
        .company-info { font-size: 9px; line-height: 1.4; color: #666; text-align: left; margin-top: 1rem; }

        /* Bloc document √† droite */
        .doc-cell { width: 30%; text-align: right; }
        .doc-title { background: #3A4556; color: white; padding: 8px 15px; font-size: 18px; font-weight: bold; letter-spacing: 3px; border-radius: 4px; margin-bottom: 8px; }
        .doc-info-table { width: 100%; border-collapse: collapse; border: 1px solid #E0E0E0; }
        .doc-info-table td { padding: 6px 8px; font-size: 9px; text-align: left; }
        .doc-label { background-color: #F8F9FA; font-weight: bold; color: #3A4556; width: 40%; border-right: 1px solid #E0E0E0; }
        .doc-value { background-color: white; }

        /* Client */
        .client-wrapper { margin: 12px 0; padding: 10px; background-color: #F8F9FA; border: 1px solid #E0E0E0; border-radius: 4px; }
        .client-label { font-size: 9px; font-weight: bold; color: #27A3B4; text-transform: uppercase; margin-bottom: 5px; letter-spacing: 1px; }
        .client-info { font-size: 10px; line-height: 1.5; }
        .client-name { font-size: 12px; font-weight: bold; color: #3A4556; margin-bottom: 3px; }

        /* Objet */
        .object-wrapper { margin: 12px 0; }
        .object-label { font-size: 9px; font-weight: bold; color: #3A4556; text-transform: uppercase; margin-bottom: 4px; }
        .object-text { font-size: 11px; padding: 8px; background-color: white; border: 1px solid #E0E0E0; border-radius: 4px; }

        /* Tableau des lignes */
        .items-table { width: 100%; border-collapse: collapse; margin: 12px 0; border: 1px solid #E0E0E0; }
        .items-table thead th { background: #3A4556; color: white; padding: 8px 10px; text-align: center; font-size: 9px; font-weight: bold; border-right: 1px solid rgba(255,255,255,0.2); border-bottom: 2px solid #27A3B4; }
        .items-table thead th:last-child { border-right: none; text-align: right; }
        .items-table thead th:first-child { text-align: left; }
        .items-table tbody td { padding: 8px 10px; border-bottom: 1px solid #E0E0E0; border-right: 1px solid #E0E0E0; font-size: 9px; vertical-align: top; }
        .items-table tbody td:last-child { border-right: none; }
        .items-table tbody tr:nth-child(even) { background-color: #F8F9FA; }
        .items-table tbody td:first-child { text-align: left; font-size: 10px; }
        .items-table tbody td:not(:first-child) { text-align: center; }
        .items-table tbody td:last-child { text-align: right; font-weight: bold; }

        /* Totaux */
        .totals-wrapper { margin: 12px 0 8px auto; width: 35%; min-width: 250px; }
        .totals-table { width: 100%; border-collapse: collapse; }
        .totals-table td { padding: 6px 10px; font-size: 10px; }
        .totals-table .label { text-align: right; color: #666; }
        .totals-table .value { text-align: right; font-weight: bold; width: 35%; }
        .total-ht-row { border-top: 1px solid #E0E0E0; }
        .total-ht-row td { padding-top: 8px; font-size: 11px; }
        .tva-row td { color: #666; font-size: 9px; padding: 4px 10px; }
        .total-final-row { background: #3A4556; color: white; }
        .total-final-row td { padding: 10px; font-size: 13px; font-weight: bold; letter-spacing: 1px; }

        /* Acompte */
        .acompte-wrapper { margin: 15px 0; padding: 12px; background-color: #E8F5E9; border-left: 4px solid #4CAF50; border-radius: 0 4px 4px 0; }
        .acompte-title { font-size: 10px; font-weight: bold; color: #2E7D32; margin-bottom: 6px; text-transform: uppercase; }
        .acompte-text { font-size: 10px; line-height: 1.6; color: #1B5E20; }

        /* Conditions */
        .conditions-wrapper { margin: 15px 0; padding: 10px; background-color: #F8F9FA; border-radius: 4px; border: 1px solid #E0E0E0; }
        .conditions-title { font-size: 10px; font-weight: bold; color: #3A4556; margin-bottom: 6px; text-transform: uppercase; }
        .conditions-text { font-size: 9px; line-height: 1.5; color: #555; }

        /* Footer */
        .footer { margin-top: 20px; padding-top: 10px; border-top: 1px solid #E0E0E0; text-align: center; font-size: 8px; color: #999; line-height: 1.4; }

        /* Print button */
        .print-button {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #27A3B4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .print-button:hover { background: #3A4556; }

        /* Media print */
        @media print {
            body { padding: 0; }
            .print-button { display: none; }
            @page {
                margin: 15mm;
                size: A4;
            }
        }
    </style>
</head>
<body>

<button class="print-button" onclick="window.print()">üñ®Ô∏è Imprimer / Enregistrer PDF</button>

<!-- En-t√™te -->
<div class="header-wrapper">
    <span class="logo-cell">
        <img src="{{ absolute_url(asset('images/logo.png')) }}" class="logo" alt="Alr√© Web">
        <div class="company-info">
            <strong>{{ company.ownerName }}</strong><br>
            {{ company.address }}<br>
            {{ company.postalCode }} {{ company.city }}<br>
            <strong>Email:</strong> {{ company.email }}<br>
            <strong>T√©l:</strong> {{ company.phone }}<br>
            <strong>SIRET:</strong> {{ company.siret }}
        </div>
    </span>
    <span class="doc-cell">
        <div class="doc-title">DEVIS</div>
        <table class="doc-info-table">
            <tbody>
                <tr>
                    <td class="doc-label">Num√©ro</td>
                    <td class="doc-value"><strong>{{ devis.number }}</strong></td>
                </tr>
                <tr>
                    <td class="doc-label">Date</td>
                    <td class="doc-value">{{ devis.dateCreation|date('d/m/Y') }}</td>
                </tr>
                <tr>
                    <td class="doc-label">Validit√©</td>
                    <td class="doc-value">{{ devis.dateValidite|date('d/m/Y') }}</td>
                </tr>
            </tbody>
        </table>
    </span>
</div>

<!-- Client -->
<div class="client-wrapper">
    <div class="client-label">Client</div>
    <div class="client-info">
        {% if devis.client.companyName %}
            <div class="client-name">{{ devis.client.companyName }}</div>
            {% if devis.client.name and devis.client.name != devis.client.companyName %}
                {{ devis.client.name }}<br>
            {% endif %}
        {% else %}
            <div class="client-name">{{ devis.client.name }}</div>
        {% endif %}
        {{ devis.client.address }}<br>
        {{ devis.client.postalCode }} {{ devis.client.city }}
        {% if devis.client.siret %}<br><strong>SIRET:</strong> {{ devis.client.siret }}{% endif %}
        {% if devis.client.vatNumber %}<br><strong>N¬∞ TVA:</strong> {{ devis.client.vatNumber }}{% endif %}
        {% if devis.client.email %}<br><strong>Email:</strong> {{ devis.client.email }}{% endif %}
        {% if devis.client.phone %}<br><strong>T√©l:</strong> {{ devis.client.phone }}{% endif %}
    </div>
</div>

<!-- Objet -->
{% if devis.title %}
<div class="object-wrapper">
    <div class="object-label">Objet</div>
    <div class="object-text">{{ devis.title }}</div>
</div>
{% endif %}

<!-- V√©rifier s'il y a des remises -->
{% set hasDiscount = false %}
{% for item in devis.items %}
    {% if item.discount and item.discount > 0 %}
        {% set hasDiscount = true %}
    {% endif %}
{% endfor %}

<!-- Lignes -->
<table class="items-table">
    <thead>
        <tr>
            <th style="width: {{ hasDiscount ? '48%' : '55%' }};">D√©signation</th>
            <th style="width: {{ hasDiscount ? '13%' : '15%' }};">Prix unit. HT</th>
            <th style="width: {{ hasDiscount ? '13%' : '15%' }};">Quantit√©</th>
            {% if hasDiscount %}<th style="width: 13%;">Remise</th>{% endif %}
            <th style="width: {{ hasDiscount ? '13%' : '15%' }};">Total HT</th>
        </tr>
    </thead>
    <tbody>
        {% for item in devis.items %}
        <tr>
            <td>{{ item.description|nl2br }}</td>
            <td>{{ item.unitPrice|number_format(2, ',', ' ') }} ‚Ç¨</td>
            <td>{{ item.quantity|number_format(2, ',', ' ') }}</td>
            {% if hasDiscount %}
                <td>{{ item.discount and item.discount > 0 ? item.discount|number_format(0) ~ '%' : '-' }}</td>
            {% endif %}
            <td>{{ item.totalAfterDiscount|number_format(2, ',', ' ') }} ‚Ç¨</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Totaux -->
{% set vatRate = devis.vatRate %}
{% set totalHt = devis.totalHt %}
{% set vatAmount = totalHt * (vatRate / 100) %}
{% set totalTtc = totalHt + vatAmount %}

<div class="totals-wrapper">
    <table class="totals-table">
        <tbody>
            <tr class="total-ht-row">
                <td class="label">Total HT</td>
                <td class="value">{{ totalHt|number_format(2, ',', ' ') }} ‚Ç¨</td>
            </tr>
            {% if vatRate > 0 %}
                <tr class="tva-row">
                    <td class="label">TVA ({{ vatRate|number_format(0) }}%)</td>
                    <td class="value">{{ vatAmount|number_format(2, ',', ' ') }} ‚Ç¨</td>
                </tr>
                <tr class="total-ht-row">
                    <td class="label">Total TTC</td>
                    <td class="value">{{ totalTtc|number_format(2, ',', ' ') }} ‚Ç¨</td>
                </tr>
            {% endif %}
            {% if devis.acompte and devis.acompte > 0 %}
                {% set finalTotal = vatRate > 0 ? totalTtc : totalHt %}
                {% set restant = finalTotal - devis.acompte %}
                <tr class="tva-row">
                    <td class="label">Acompte</td>
                    <td class="value">- {{ devis.acompte|number_format(2, ',', ' ') }} ‚Ç¨</td>
                </tr>
                <tr class="total-final-row">
                    <td class="label">RESTE √Ä PAYER</td>
                    <td class="value">{{ restant|number_format(2, ',', ' ') }} ‚Ç¨</td>
                </tr>
            {% else %}
                {% set finalTotal = vatRate > 0 ? totalTtc : totalHt %}
                <tr class="total-final-row">
                    <td class="label">TOTAL</td>
                    <td class="value">{{ finalTotal|number_format(2, ',', ' ') }} ‚Ç¨</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Acompte demand√© -->
{% if devis.acompte and devis.acompte > 0 %}
<div class="acompte-wrapper">
    <div class="acompte-title">Acompte demand√© √† la signature</div>
    <div class="acompte-text">
        {% if devis.acomptePercentage and devis.acomptePercentage > 0 %}
            <strong>{{ devis.acomptePercentage|number_format(0) }}%</strong> du montant total, soit <strong>{{ devis.acompte|number_format(2, ',', ' ') }} ‚Ç¨</strong>
        {% else %}
            <strong>{{ devis.acompte|number_format(2, ',', ' ') }} ‚Ç¨</strong>
        {% endif %}
        <br>Le solde sera factur√© √† la livraison du projet.
    </div>
</div>
{% endif %}

<!-- Conditions -->
{% if devis.conditions %}
<div class="conditions-wrapper">
    <div class="conditions-title">Conditions</div>
    <div class="conditions-text">{{ devis.conditions|nl2br }}</div>
</div>
{% endif %}

<!-- Footer -->
<div class="footer">
    Devis valable jusqu'au {{ devis.dateValidite|date('d/m/Y') }} - Devis non contractuel<br>
    {{ company.name }} - SIRET: {{ company.siret }}<br>
    {% if vatRate == 0 %}TVA non applicable, art. 293 B du CGI - {% endif %}Dispens√© d'immatriculation au registre du commerce et des soci√©t√©s (RCS) et au r√©pertoire des m√©tiers (RM)
</div>

</body>
</html>
